<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="勤怠管理【東京架設】">
  <title>勤怠管理【東京架設】</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background-color: #0f172a;
      color: #f1f5f9;
    }
    #app {
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    input, select, textarea, button {
      font-family: inherit;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #60a5fa !important;
    }
    
    /* ログイン画面 */
    .login-container {
      padding: 40px 20px;
      max-width: 500px;
      margin: 0 auto;
    }
    .logo-section {
      text-align: center;
      margin-bottom: 40px;
    }
    .logo {
      font-size: 64px;
      margin-bottom: 16px;
    }
    .app-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .app-subtitle {
      font-size: 14px;
      color: #94a3b8;
    }
    .input-group {
      margin-bottom: 20px;
    }
    .input-label {
      display: block;
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .login-input {
      width: 100%;
      padding: 18px 16px;
      background-color: #1e293b;
      border: 2px solid #475569;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 18px;
    }
    .login-error {
      color: #ef4444;
      font-size: 14px;
      text-align: center;
      margin-bottom: 16px;
      padding: 12px;
      background-color: rgba(239, 68, 68, 0.1);
      border-radius: 8px;
      display: none;
    }
    .login-error.show {
      display: block;
    }
    .login-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      border-radius: 14px;
      color: white;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .login-hint {
      font-size: 12px;
      color: #64748b;
      text-align: center;
    }
    
    /* ヘッダー */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background-color: #1e293b;
      border-bottom: 1px solid #334155;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .menu-btn {
      background: none;
      border: 1px solid #475569;
      color: #94a3b8;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .back-btn {
      background: none;
      border: none;
      color: #60a5fa;
      padding: 8px 0;
      cursor: pointer;
      font-size: 16px;
    }
    .header-title {
      font-size: 18px;
      font-weight: 600;
    }
    .date-text {
      font-size: 14px;
      color: #94a3b8;
    }
    /* お知らせ表示（一般ユーザー） */
    .user-announcement {
      background-color: rgba(239, 68, 68, 0.15);
      border: 1px solid #ef4444;
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 16px;
      font-size: 12px;
      color: #f87171;
      text-align: center;
    }
    /* お知らせ送信（管理者） */
    .announcement-section {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .announcement-title {
      font-size: 14px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 12px;
    }
    .announcement-form {
      display: flex;
      gap: 8px;
    }
    .announcement-input {
      flex: 1;
      padding: 10px 12px;
      background-color: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
    }
    .send-announcement-btn {
      padding: 10px 16px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .current-announcement {
      background-color: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      border-radius: 8px;
      padding: 12px;
    }
    .current-announcement-text {
      color: #f87171;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .current-announcement-date {
      color: #94a3b8;
      font-size: 11px;
      margin-bottom: 10px;
    }
    .cancel-announcement-btn {
      width: 100%;
      padding: 8px;
      background-color: #475569;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }
    
    /* ホーム画面 */
    .home-content {
      padding: 30px 20px;
      max-width: 500px;
      margin: 0 auto;
    }
    .greeting {
      text-align: center;
      margin-bottom: 20px;
    }
    .greeting-text {
      font-size: 16px;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    .user-name {
      font-size: 24px;
      font-weight: 700;
    }
    .clock-display {
      text-align: center;
      font-size: 48px;
      font-weight: 300;
      font-family: "SF Mono", "Fira Code", monospace;
      color: #60a5fa;
      margin-bottom: 30px;
      letter-spacing: 2px;
    }
    .button-container {
      display: flex;
      gap: 16px;
      margin-bottom: 30px;
    }
    .main-btn {
      flex: 1;
      padding: 30px 20px;
      border-radius: 20px;
      border: none;
      color: white;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .main-btn:disabled {
      opacity: 0.5;
    }
    .clock-in-btn {
      background: linear-gradient(135deg, #f59e0b, #ef4444);
    }
    .clock-out-btn {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    }
    .btn-icon {
      font-size: 32px;
    }
    .status-card {
      background-color: #1e293b;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .status-title {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    .status-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .status-detail {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    .status-otsukare {
      font-size: 16px;
      color: #10b981;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .month-selector {
      margin-bottom: 16px;
    }
    .month-select {
      width: 100%;
      padding: 14px 16px;
      background-color: #1e293b;
      border: 1px solid #475569;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
    }
    .month-summary {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .month-summary-item {
      flex: 1;
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
      border: 1px solid #3b82f6;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .month-summary-label {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 6px;
    }
    .month-summary-value {
      display: block;
      font-size: 24px;
      font-weight: 700;
      color: #f1f5f9;
    }
    .calendar-toggle-btn {
      background: none;
      border: 1px solid #475569;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      padding: 6px 10px;
    }
    .calendar-popup {
      position: fixed;
      top: 70px;
      right: 12px;
      z-index: 200;
      background-color: #1e293b;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      width: 260px;
    }
    .calendar-popup.hidden {
      display: none;
    }
    .mini-calendar {
      background-color: transparent;
      border-radius: 0;
      padding: 0;
      margin-bottom: 0;
    }
    .mini-calendar-header {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 8px;
    }
    .mini-calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    .mini-calendar-weekdays .sunday { color: #ef4444; }
    .mini-calendar-weekdays .saturday { color: #3b82f6; }
    .mini-calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      text-align: center;
    }
    .mini-calendar-days span {
      font-size: 12px;
      padding: 4px 0;
      border-radius: 4px;
      color: #e2e8f0;
    }
    .mini-calendar-days span.empty { visibility: hidden; }
    .mini-calendar-days span.today {
      background-color: #3b82f6;
      color: white;
      font-weight: 700;
    }
    .mini-calendar-days span.holiday { color: #ef4444; }
    .mini-calendar-days span.saturday { color: #3b82f6; }
    .mini-calendar-days span.worked::after {
      content: '';
      display: block;
      width: 4px;
      height: 4px;
      background-color: #10b981;
      border-radius: 50%;
      margin: 0 auto;
    }
    .paid-leave-info {
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
      border: 1px solid #3b82f6;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 13px;
      color: #93c5fd;
      margin-bottom: 12px;
      text-align: center;
    }
    .paid-leave-info.today {
      background: linear-gradient(135deg, #14532d, #1e293b);
      border-color: #10b981;
      color: #6ee7b7;
    }
    .gps-notice {
      font-size: 11px;
      color: #64748b;
      text-align: center;
      margin: -8px 0 12px 0;
    }
    .home-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .settings-btn {
      width: 100%;
      padding: 14px;
      background-color: #475569;
      border: none;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 15px;
      cursor: pointer;
    }
    .settings-section {
      margin-bottom: 24px;
    }
    .settings-section-title {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #334155;
    }
    .settings-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .settings-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 8px;
    }
    .settings-card-desc {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    .settings-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .settings-input {
      flex: 1;
      padding: 12px;
      background-color: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
    }
    .settings-save-btn {
      padding: 12px 16px;
      background-color: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .settings-card-note {
      font-size: 11px;
      color: #64748b;
      margin-top: 8px;
    }
    .address-request-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid #f59e0b;
    }
    .address-request-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .address-request-employee {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
    }
    .address-request-date {
      font-size: 12px;
      color: #94a3b8;
    }
    .address-request-detail {
      font-size: 14px;
      color: #e2e8f0;
      background-color: #0f172a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .address-request-actions {
      margin-bottom: 8px;
    }
    .confirm-address-btn {
      width: 100%;
      padding: 12px;
      background-color: #10b981;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .address-request-note {
      font-size: 11px;
      color: #64748b;
      text-align: center;
    }
    .history-btn {
      width: 100%;
      padding: 16px;
      background-color: #334155;
      border: none;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 16px;
      cursor: pointer;
    }
    
    /* フォーム画面 */
    .form-content {
      padding: 20px;
      max-width: 500px;
      margin: 0 auto;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #334155;
    }
    .info-label {
      color: #94a3b8;
    }
    .info-value {
      font-weight: 500;
    }
    .divider {
      height: 1px;
      background-color: #334155;
      margin: 20px 0;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .form-select {
      width: 100%;
      padding: 16px;
      background-color: #1e293b;
      border: 2px solid #475569;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 16px;
      margin-bottom: 12px;
    }
    .form-input {
      width: 100%;
      padding: 16px;
      background-color: #1e293b;
      border: 2px solid #475569;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 16px;
      margin-bottom: 12px;
    }
    .form-textarea {
      width: 100%;
      padding: 16px;
      background-color: #1e293b;
      border: 2px solid #475569;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 16px;
      min-height: 100px;
      resize: vertical;
      margin-bottom: 12px;
    }
    .gps-section {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .gps-info {
      font-size: 14px;
      color: #94a3b8;
    }
    .gps-loading {
      color: #60a5fa;
    }
    .demo-text {
      color: #f59e0b;
      font-size: 12px;
    }
    .error-text {
      color: #ef4444;
      font-size: 14px;
    }
    .confirm-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      border-radius: 14px;
      color: white;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
    }
    .confirm-btn:disabled {
      opacity: 0.5;
    }
    
    /* リスト画面 */
    .list-content {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .date-input {
      width: 100%;
      padding: 16px;
      background-color: #1e293b;
      border: 2px solid #475569;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 16px;
      margin-bottom: 12px;
    }
    .attendance-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background-color: #1e293b;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .attendance-date {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
    }
    .attendance-count {
      font-size: 14px;
      color: #3b82f6;
      font-weight: 600;
    }
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .attendance-cell {
      background-color: #1e293b;
      border-radius: 10px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.1s, background-color 0.1s;
      border: 2px solid transparent;
    }
    .attendance-cell:active {
      transform: scale(0.97);
    }
    .attendance-cell.present {
      border-color: #10b981;
    }
    .attendance-cell.present.all-completed {
      border-color: #f59e0b;
    }
    .attendance-cell.present:hover {
      background-color: #1e3a3a;
    }
    .attendance-cell.absent {
      opacity: 0.6;
    }
    .attendance-name {
      display: block;
      font-size: 12px;
      color: #e2e8f0;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .attendance-mark {
      display: block;
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
    }
    .attendance-marks {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 4px 0;
    }
    .attendance-mark-item {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.05);
      transition: background-color 0.15s;
    }
    .attendance-mark-item:hover {
      background-color: rgba(255,255,255,0.15);
    }
    .attendance-mark-item:active {
      background-color: rgba(255,255,255,0.2);
    }
    .mark-circle {
      font-size: 22px;
      font-weight: 700;
      line-height: 1;
    }
    .attendance-mark-item.working .mark-circle,
    .attendance-mark-item.working .mark-shift {
      color: #10b981;
    }
    .attendance-mark-item.completed .mark-circle,
    .attendance-mark-item.completed .mark-shift {
      color: #f59e0b;
    }
    .mark-shift {
      font-size: 10px;
      font-weight: 700;
      line-height: 1;
      margin-top: 1px;
    }
    .mark-done {
      font-size: 8px;
      color: #94a3b8;
      margin-top: -2px;
    }
    .attendance-cell.present .attendance-mark {
      color: #10b981;
    }
    .attendance-cell.absent .attendance-mark {
      color: #64748b;
    }
    .attendance-site {
      display: block;
      font-size: 10px;
      color: #94a3b8;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .attendance-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .attendance-detail-modal.hidden {
      display: none;
    }
    .attendance-detail-content {
      background-color: #1e293b;
      border-radius: 16px;
      padding: 20px;
      width: 100%;
      max-width: 350px;
      position: relative;
    }
    .attendance-detail-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #475569;
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
    }
    .attendance-detail-name {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 16px;
      padding-right: 30px;
    }
    .attendance-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #334155;
      font-size: 14px;
    }
    .attendance-detail-row:last-child {
      border-bottom: none;
    }
    .attendance-detail-label {
      color: #94a3b8;
    }
    .attendance-detail-value {
      color: #f1f5f9;
      font-weight: 500;
    }
    .attendance-detail-map-btn {
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      background-color: #3b82f6;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .attendance-detail-map-btn:disabled {
      background-color: #475569;
      opacity: 0.5;
      cursor: not-allowed;
    }
    .attendance-detail-delete-btn {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      background-color: #dc2626;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    /* 稼働現場一覧グリッド */
    .site-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .site-cell {
      background-color: #1e293b;
      border-radius: 10px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.1s, background-color 0.1s;
      border: 2px solid transparent;
    }
    .site-cell:active {
      transform: scale(0.97);
    }
    .site-cell.active {
      border-color: #10b981;
    }
    .site-cell.active.all-completed {
      border-color: #f59e0b;
    }
    .site-cell.inactive {
      opacity: 0.6;
    }
    .site-cell-name {
      display: block;
      font-size: 11px;
      color: #e2e8f0;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .site-cell-mark {
      display: block;
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
    }
    .site-cell.active .site-cell-mark {
      color: #10b981;
    }
    .site-cell.active.all-completed .site-cell-mark {
      color: #f59e0b;
    }
    .site-cell.inactive .site-cell-mark {
      color: #64748b;
    }
    .site-cell-count {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }
    /* 現場詳細モーダル */
    .site-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .site-detail-modal.hidden {
      display: none;
    }
    .site-detail-modal-content {
      background-color: #1e293b;
      border-radius: 16px;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .site-detail-modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #475569;
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
    }
    .site-detail-title {
      font-size: 16px;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 16px;
      padding-right: 30px;
    }
    .site-detail-section {
      margin-bottom: 16px;
    }
    .site-detail-section-title {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .site-worker-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #334155;
      font-size: 13px;
    }
    .site-worker-row:last-child {
      border-bottom: none;
    }
    .site-worker-name {
      color: #f1f5f9;
    }
    .site-worker-time {
      color: #94a3b8;
      font-size: 12px;
    }
    .site-worker-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }
    .site-worker-status.working {
      background-color: #10b981;
      color: white;
    }
    .site-worker-status.completed {
      background-color: #f59e0b;
      color: white;
    }
    .site-report-input-group {
      margin-bottom: 12px;
    }
    .site-report-label {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    .site-report-input {
      width: 100%;
      padding: 10px;
      background-color: #0f172a;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
    }
    .site-report-save-btn {
      width: 100%;
      padding: 12px;
      background-color: #3b82f6;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .site-section {
      margin-bottom: 24px;
    }
    .site-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    .completed-section {
      opacity: 0.7;
    }
    .site-cell.completed-site {
      background-color: #374151;
      border-color: #6b7280;
    }
    .site-cell.completed-site .site-cell-mark {
      color: #10b981;
    }
    .site-cell-date {
      display: block;
      font-size: 10px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .site-scaffolding-badge {
      display: inline-block;
      font-size: 9px;
      background-color: #3b82f6;
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      margin-top: 4px;
    }
    .site-completion-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #475569;
    }
    .site-completion-title {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .site-completion-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
    }
    .site-completion-btn.scaffolding {
      background-color: #8b5cf6;
    }
    .site-completion-btn.scaffolding.done {
      background-color: #6b7280;
    }
    .site-completion-btn.complete {
      background-color: #f59e0b;
    }
    .site-completion-btn.restore {
      background-color: #10b981;
    }
    /* 各現場収支 */
    .finance-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .finance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #475569;
    }
    .finance-site-name {
      font-size: 15px;
      font-weight: 600;
      color: #f1f5f9;
    }
    .finance-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    .finance-status.active {
      background-color: #10b981;
      color: white;
    }
    .finance-status.completed {
      background-color: #6b7280;
      color: white;
    }
    .finance-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 13px;
    }
    .finance-row.total {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #475569;
      font-weight: 600;
    }
    .finance-label {
      color: #94a3b8;
    }
    .finance-value {
      color: #f1f5f9;
    }
    .finance-value.profit-positive {
      color: #10b981;
    }
    .finance-value.profit-negative {
      color: #ef4444;
    }
    .finance-sub-info {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 11px;
      color: #64748b;
    }
    /* 各現場収支リンクカード */
    .finance-card-link {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: background-color 0.15s;
    }
    .finance-card-link:active {
      background-color: #334155;
    }
    .finance-link-text {
      font-size: 12px;
      color: #60a5fa;
      margin-top: 8px;
    }
    .finance-status.scaffolding {
      background-color: #8b5cf6;
      color: white;
    }
    /* 収支詳細画面 */
    .finance-detail-header {
      margin-bottom: 16px;
    }
    .finance-detail-site-name {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
      margin: 0 0 4px 0;
    }
    .finance-detail-status {
      font-size: 12px;
      color: #94a3b8;
      margin: 0;
    }
    .finance-summary-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .finance-summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
      color: #f1f5f9;
    }
    .finance-summary-row.total {
      border-top: 1px solid #475569;
      margin-top: 8px;
      padding-top: 12px;
      font-weight: 700;
      font-size: 16px;
    }
    .finance-summary-row.rate {
      font-size: 14px;
      color: #94a3b8;
    }
    .finance-phase-section {
      margin-bottom: 24px;
    }
    .finance-phase-section.disabled {
      opacity: 0.5;
    }
    .finance-phase-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .finance-phase-title {
      font-size: 15px;
      font-weight: 600;
      color: #f1f5f9;
      margin: 0;
    }
    .finance-add-month-btn {
      background-color: #3b82f6;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      color: white;
      font-size: 11px;
      cursor: pointer;
    }
    .finance-phase-summary {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    .finance-month-card {
      background-color: #1e293b;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .finance-month-card:active {
      background-color: #334155;
    }
    .finance-month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .finance-month-title {
      font-size: 13px;
      font-weight: 600;
      color: #f1f5f9;
    }
    .finance-month-edit {
      font-size: 11px;
      color: #60a5fa;
    }
    .finance-month-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #94a3b8;
      padding: 2px 0;
    }
    .empty-text-small {
      text-align: center;
      color: #64748b;
      padding: 16px;
      font-size: 13px;
    }
    /* 収支詳細 新デザイン */
    .finance-section-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .finance-section-card.disabled {
      opacity: 0.5;
    }
    .finance-section-title {
      font-size: 15px;
      font-weight: 600;
      color: #f1f5f9;
      margin: 0 0 16px 0;
    }
    .finance-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .finance-input-row label {
      flex: 0 0 100px;
      font-size: 13px;
      color: #94a3b8;
    }
    .finance-input {
      flex: 1;
      padding: 10px 12px;
      background-color: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
      text-align: right;
    }
    .finance-unit {
      font-size: 12px;
      color: #64748b;
      width: 24px;
    }
    .finance-display-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 13px;
      color: #94a3b8;
      border-bottom: 1px solid #334155;
      margin-bottom: 12px;
    }
    .finance-save-btn {
      width: 100%;
      padding: 12px;
      background-color: #3b82f6;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .finance-result-box {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #475569;
    }
    .finance-result-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
      color: #f1f5f9;
    }
    .finance-result-row.total {
      font-weight: 700;
      font-size: 16px;
    }
    /* アコーディオン式収支 */
    .finance-top-summary {
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .finance-top-name {
      font-size: 16px;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 8px;
    }
    .finance-top-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #94a3b8;
      padding: 4px 0;
    }
    .finance-top-row span:last-child {
      font-weight: 600;
      font-size: 16px;
    }
    .accordion-item {
      background-color: #1e293b;
      border-radius: 10px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .accordion-item.disabled {
      opacity: 0.5;
    }
    .accordion-header {
      padding: 14px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #f1f5f9;
      cursor: pointer;
      background-color: #334155;
    }
    .accordion-body {
      padding: 12px;
    }
    .accordion-body.hidden {
      display: none;
    }
    .acc-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .acc-row label {
      flex: 0 0 80px;
      color: #94a3b8;
    }
    .acc-row.display {
      justify-content: space-between;
      padding: 8px;
      background-color: #0f172a;
      border-radius: 6px;
      color: #94a3b8;
    }
    .acc-input {
      flex: 1;
      padding: 8px;
      background-color: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #f1f5f9;
      font-size: 13px;
      text-align: right;
    }
    .acc-row span:last-child {
      color: #64748b;
      font-size: 11px;
      width: 20px;
    }
    .acc-material-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #334155;
    }
    .acc-material-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
      color: #94a3b8;
    }
    .acc-add-btn {
      background-color: #3b82f6;
      border: none;
      border-radius: 4px;
      color: white;
      width: 28px;
      height: 28px;
      font-size: 16px;
      cursor: pointer;
    }
    .material-month-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background-color: #0f172a;
      border-radius: 6px;
      margin-bottom: 4px;
      font-size: 11px;
      color: #94a3b8;
    }
    .material-del-btn {
      background: none;
      border: none;
      color: #ef4444;
      font-size: 12px;
      cursor: pointer;
      padding: 4px;
    }
    .acc-save-btn {
      width: 100%;
      padding: 10px;
      background-color: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .acc-empty {
      font-size: 11px;
      color: #64748b;
    }
    .date-label {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .empty-text {
      text-align: center;
      color: #64748b;
      padding: 40px;
    }
    .record-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .record-date, .record-name {
      font-weight: 600;
    }
    .record-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .record-status.working {
      background-color: #48bb78;
    }
    .record-status.completed {
      background-color: #4299e1;
    }
    .record-site {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    .record-time {
      font-size: 14px;
      color: #60a5fa;
    }
    .record-memo {
      font-size: 13px;
      color: #94a3b8;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #334155;
    }
    
    /* 管理者画面 */
    .admin-content {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .admin-date {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .stats-container {
      display: flex;
      gap: 16px;
      margin-bottom: 30px;
    }
    .stat-card {
      flex: 1;
      background-color: #1e293b;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }
    .stat-number {
      display: block;
      font-size: 40px;
      font-weight: 700;
      color: #60a5fa;
      margin-bottom: 8px;
    }
    .stat-label {
      font-size: 14px;
      color: #94a3b8;
    }
    .site-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .site-name {
      font-weight: 600;
    }
    .site-count {
      font-size: 14px;
      color: #94a3b8;
    }
    .worker-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .worker-tag {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: white;
    }
    .worker-tag.working {
      background-color: #48bb78;
    }
    .worker-tag.completed {
      background-color: #718096;
    }
    .menu-section {
      margin-top: 30px;
    }
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .menu-card {
      background-color: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      color: #f1f5f9;
      font-size: 14px;
      font-weight: 500;
    }
    .menu-card-wide {
      background-color: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 12px 16px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: #94a3b8;
      font-size: 12px;
      font-weight: 500;
      width: 100%;
      margin-top: 12px;
    }
    .menu-card-wide .menu-icon {
      font-size: 16px;
    }
    .menu-icon {
      font-size: 28px;
    }
    
    /* マスタ画面 */
    .add-form {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .form-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #f1f5f9;
    }
    .add-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .master-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .master-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .master-name {
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
    }
    .master-role {
      font-size: 13px;
      color: #94a3b8;
      background-color: #334155;
      padding: 4px 10px;
      border-radius: 8px;
    }
    .master-detail {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    .toggle-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .toggle-btn.active {
      background-color: #48bb78;
    }
    .toggle-btn.inactive {
      background-color: #e53e3e;
    }
    .employee-id-badge {
      background-color: #3b82f6;
      color: white;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 10px;
    }
    .password-section {
      background-color: #0f172a;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .password-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .password-label {
      font-size: 13px;
      color: #94a3b8;
    }
    .password-value {
      font-size: 14px;
      font-family: monospace;
      color: #f1f5f9;
    }
    .show-password-btn {
      background-color: #475569;
      border: none;
      border-radius: 6px;
      color: #f1f5f9;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .password-change-row {
      display: flex;
      gap: 8px;
    }
    .password-input {
      flex: 1;
      padding: 10px 12px;
      background-color: #1e293b;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
    }
    .change-password-btn {
      background-color: #f59e0b;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .site-detail-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .site-detail-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .site-stats {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 16px;
    }
    .worker-detail-list {
      border-top: 1px solid #334155;
      padding-top: 12px;
    }
    .worker-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #334155;
      font-size: 14px;
    }
    
    .hidden {
      display: none !important;
    }
    .or-divider {
      text-align: center;
      margin: 16px 0;
      position: relative;
    }
    .or-divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background-color: #475569;
    }
    .or-divider span {
      background-color: #0f172a;
      padding: 0 16px;
      color: #94a3b8;
      font-size: 14px;
      position: relative;
    }
    .input-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: -8px;
      margin-bottom: 12px;
    }
    .edit-section {
      background-color: #0f172a;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .edit-row {
      margin-bottom: 12px;
    }
    .edit-row:last-child {
      margin-bottom: 0;
    }
    .edit-label {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 6px;
    }
    .edit-input-group {
      display: flex;
      gap: 8px;
    }
    .edit-input {
      flex: 1;
      padding: 10px 12px;
      background-color: #1e293b;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
    }
    .edit-select {
      flex: 1;
      padding: 10px 12px;
      background-color: #1e293b;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
    }
    .edit-save-btn {
      padding: 10px 16px;
      background-color: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .edit-save-btn:active {
      background-color: #2563eb;
    }
    /* 古情報削除画面 */
    .cleanup-section {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .cleanup-section.danger {
      border: 1px solid #ef4444;
    }
    .cleanup-stats {
      margin-top: 12px;
    }
    .cleanup-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      color: #f1f5f9;
    }
    .cleanup-stat-row:last-child {
      border-bottom: none;
    }
    .cleanup-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background-color: #0f172a;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .cleanup-option-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .cleanup-option-title {
      font-size: 14px;
      color: #f1f5f9;
    }
    .cleanup-option-count {
      font-size: 12px;
      color: #94a3b8;
    }
    .cleanup-btn {
      padding: 8px 16px;
      background-color: #475569;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }
    .cleanup-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .cleanup-btn.danger {
      background-color: #dc2626;
      width: 100%;
      padding: 14px;
      font-size: 14px;
      margin-top: 12px;
    }
    .cleanup-warning {
      font-size: 13px;
      color: #f87171;
      margin-bottom: 8px;
    }
    .backup-desc {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 16px;
    }
    .backup-buttons {
      display: flex;
      gap: 12px;
    }
    .backup-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }
    .backup-btn.export {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    .backup-btn.import {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* お知らせ機能 */
    .announcement-section {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .announcement-section.current {
      border: 1px solid #f59e0b;
    }
    .announcement-desc {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 16px;
    }
    .announcement-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .announcement-input {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background-color: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    .announcement-btn {
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .announcement-btn.send {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    .announcement-btn.cancel {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }
    .current-announcement {
      background-color: #0f172a;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .current-announcement-text {
      font-size: 14px;
      color: #f1f5f9;
      white-space: pre-wrap;
      margin-bottom: 8px;
    }
    .current-announcement-date {
      font-size: 11px;
      color: #64748b;
    }
    .no-announcement {
      font-size: 14px;
      color: #64748b;
      text-align: center;
      padding: 20px;
    }
    .home-announcement {
      background-color: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 16px;
    }
    .home-announcement-text {
      font-size: 12px;
      color: #ef4444;
      white-space: pre-wrap;
    }
    .site-delete-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .site-delete-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background-color: #0f172a;
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .site-delete-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      flex: 1;
    }
    .site-delete-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
    }
    .site-delete-name {
      font-size: 13px;
      color: #f1f5f9;
    }
    .site-delete-info {
      font-size: 11px;
      color: #94a3b8;
    }
    .delete-selected-sites {
      width: 100%;
      background-color: #dc2626;
      margin-top: 8px;
    }
    .export-section {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .export-desc {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 16px;
    }
    .export-form {
      margin-top: 16px;
    }
    .export-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    .export-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background-color: #0f172a;
      border-radius: 8px;
      cursor: pointer;
    }
    .export-option input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
    }
    .export-option span {
      font-size: 14px;
      color: #f1f5f9;
    }
    .export-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }
    .export-btn:active {
      opacity: 0.9;
    }
    .export-preview {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 20px;
    }
    .delete-emp-btn {
      width: 100%;
      padding: 12px;
      background-color: transparent;
      border: 1px solid #e53e3e;
      border-radius: 8px;
      color: #e53e3e;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
    }
    .role-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .role-badge.worker {
      background-color: #3b82f6;
    }
    .role-badge.manager {
      background-color: #10b981;
    }
    .role-badge.parttime {
      background-color: #f59e0b;
    }
    .role-badge.subadmin {
      background-color: #8b5cf6;
    }
    .admin-clockin-section, .subadmin-clockin-section {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 1px solid #475569;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: center;
    }
    .admin-greeting, .subadmin-greeting {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 12px;
    }
    .admin-buttons, .subadmin-buttons {
      display: flex;
      gap: 12px;
    }
    .admin-btn, .subadmin-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      color: white;
    }
    .admin-btn.clock-in, .subadmin-btn.clock-in {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    .admin-btn.clock-out, .subadmin-btn.clock-out {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    .admin-btn:disabled, .subadmin-btn:disabled {
      background: #475569;
      opacity: 0.5;
      cursor: not-allowed;
    }
    .site-card.excluded-site {
      opacity: 0.7;
      border-left: 3px solid #64748b;
    }
    .input-label-small {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 6px;
    }
    .break-info-card {
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
      border: 1px solid #3b82f6;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .break-info-title {
      font-size: 14px;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 12px;
    }
    .break-info-table {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      overflow: hidden;
    }
    .break-info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .break-info-row:last-child {
      border-bottom: none;
    }
    .break-info-row span:first-child {
      color: #94a3b8;
      font-size: 13px;
    }
    .break-info-row span:last-child {
      color: #f1f5f9;
      font-weight: 600;
      font-size: 13px;
    }
    .break-info-note {
      font-size: 11px;
      color: #64748b;
      margin-top: 10px;
      text-align: center;
    }
    .income-tracker-card {
      background: linear-gradient(135deg, #065f46, #064e3b);
      border: 1px solid #10b981;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .income-tracker-title {
      font-size: 14px;
      font-weight: 600;
      color: #6ee7b7;
      margin-bottom: 12px;
    }
    .income-tracker-main {
      display: flex;
      gap: 12px;
    }
    .income-tracker-item {
      flex: 1;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }
    .income-tracker-item.highlight {
      background-color: rgba(16, 185, 129, 0.2);
      border: 1px solid #10b981;
    }
    .income-tracker-label {
      display: block;
      font-size: 11px;
      color: #a7f3d0;
      margin-bottom: 4px;
    }
    .income-tracker-value {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }
    .income-tracker-note {
      font-size: 10px;
      color: #6ee7b7;
      margin-top: 10px;
      text-align: center;
    }
    .income-wall-card {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 1px solid #475569;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .income-wall-title {
      font-size: 14px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 4px;
    }
    .income-wall-subtitle {
      font-size: 10px;
      color: #64748b;
      margin-bottom: 12px;
    }
    .income-wall-table {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .income-wall-row {
      display: flex;
      gap: 12px;
      padding: 10px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.03);
      border-left: 3px solid #64748b;
    }
    .income-wall-row.safe {
      border-left-color: #10b981;
      background-color: rgba(16, 185, 129, 0.1);
    }
    .income-wall-row.over {
      border-left-color: #ef4444;
      background-color: rgba(239, 68, 68, 0.1);
    }
    .income-wall-left {
      min-width: 80px;
      text-align: center;
    }
    .income-wall-amount {
      display: block;
      font-size: 15px;
      font-weight: 700;
      color: #f1f5f9;
    }
    .income-wall-type {
      display: block;
      font-size: 9px;
      color: #94a3b8;
      margin-top: 2px;
    }
    .income-wall-right {
      flex: 1;
    }
    .income-wall-desc {
      font-size: 11px;
      color: #94a3b8;
      line-height: 1.4;
    }
    .income-wall-footer {
      font-size: 9px;
      color: #475569;
      margin-top: 10px;
      text-align: center;
    }
    .deleted-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px dashed #475569;
    }
    .deleted-card {
      opacity: 0.7;
      border: 1px dashed #64748b;
    }
    .restore-btn {
      padding: 8px 16px;
      background-color: #10b981;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .data-manage-section {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .reset-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    .reset-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      background-color: #0f172a;
      border-radius: 10px;
      border: 2px solid transparent;
      cursor: pointer;
    }
    .reset-option:has(input:checked) {
      border-color: #3b82f6;
      background-color: rgba(59, 130, 246, 0.1);
    }
    .reset-option.warning:has(input:checked) {
      border-color: #f59e0b;
      background-color: rgba(245, 158, 11, 0.1);
    }
    .reset-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: #3b82f6;
    }
    .reset-option-content {
      flex: 1;
    }
    .reset-option-title {
      display: block;
      font-size: 15px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 4px;
    }
    .reset-option-desc {
      display: block;
      font-size: 13px;
      color: #94a3b8;
    }
    .reset-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .warning-box {
      background-color: rgba(245, 158, 11, 0.1);
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    .warning-box p {
      font-size: 13px;
      color: #f59e0b;
      margin-bottom: 4px;
    }
    .warning-box p:last-child {
      margin-bottom: 0;
    }
    .data-stats {
      background-color: #0f172a;
      border-radius: 8px;
      padding: 4px;
    }
    .data-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid #1e293b;
    }
    .data-stat-row:last-child {
      border-bottom: none;
    }
    .data-stat-row span:first-child {
      color: #94a3b8;
    }
    .data-stat-row span:last-child {
      font-weight: 600;
      color: #f1f5f9;
    }
    .map-container {
      width: 100%;
      height: 200px;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 12px;
    }
    .map-btn {
      background-color: #3b82f6;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
    }
    .map-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    .map-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background-color: #1e293b;
    }
    .map-modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
    }
    .map-modal-close {
      background: none;
      border: none;
      color: #f1f5f9;
      font-size: 24px;
      cursor: pointer;
      padding: 0 8px;
    }
    .map-modal-body {
      flex: 1;
      position: relative;
    }
    .map-modal-body #modalMap {
      width: 100%;
      height: 100%;
    }
    .map-info {
      padding: 12px 16px;
      background-color: #1e293b;
      font-size: 13px;
      color: #94a3b8;
    }
    
    /* 本日の勤怠履歴 */
    .today-history {
      background-color: #1e293b;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .today-record {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      padding: 12px 0;
      border-bottom: 1px solid #334155;
    }
    .today-record:last-child {
      border-bottom: none;
    }
    .today-record-num {
      background-color: #3b82f6;
      color: white;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
    }
    .today-record-site {
      font-weight: 500;
      flex: 1;
    }
    .today-record-time {
      font-size: 13px;
      color: #94a3b8;
    }
    .today-record-status {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      color: white;
    }
    .today-record-status.working {
      background-color: #48bb78;
    }
    .today-record-status.completed {
      background-color: #718096;
    }
    .correction-btn {
      background-color: #f59e0b;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      margin-left: auto;
    }
    
    /* 修正依頼カード */
    .correction-card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid #f59e0b;
    }
    .correction-card.approved {
      border-left-color: #48bb78;
      opacity: 0.7;
    }
    .correction-card.rejected {
      border-left-color: #e53e3e;
      opacity: 0.7;
    }
    .correction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .correction-employee {
      font-weight: 600;
      font-size: 16px;
    }
    .correction-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .correction-status.pending {
      background-color: #f59e0b;
    }
    .correction-status.approved {
      background-color: #48bb78;
    }
    .correction-status.rejected {
      background-color: #e53e3e;
    }
    .correction-date {
      font-size: 14px;
      color: #60a5fa;
      margin-bottom: 4px;
    }
    .correction-detail {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .correction-reason {
      font-size: 14px;
      color: #f1f5f9;
      background-color: #0f172a;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .correction-time {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 12px;
    }
    .correction-actions {
      display: flex;
      gap: 10px;
    }
    .approve-btn {
      flex: 1;
      padding: 12px;
      background-color: #48bb78;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .reject-btn {
      flex: 1;
      padding: 12px;
      background-color: #e53e3e;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* 管理者画面のアラート表示 */
    .stat-card.alert {
      background-color: #7c2d12;
    }
    .menu-card.has-alert {
      background-color: #7c2d12;
      border-color: #f59e0b;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // 日本の祝日データ（2025-2026年）
    const HOLIDAYS = {
      '2025-01-01': '元日',
      '2025-01-13': '成人の日',
      '2025-02-11': '建国記念の日',
      '2025-02-23': '天皇誕生日',
      '2025-02-24': '振替休日',
      '2025-03-20': '春分の日',
      '2025-04-29': '昭和の日',
      '2025-05-03': '憲法記念日',
      '2025-05-04': 'みどりの日',
      '2025-05-05': 'こどもの日',
      '2025-05-06': '振替休日',
      '2025-07-21': '海の日',
      '2025-08-11': '山の日',
      '2025-09-15': '敬老の日',
      '2025-09-23': '秋分の日',
      '2025-10-13': 'スポーツの日',
      '2025-11-03': '文化の日',
      '2025-11-23': '勤労感謝の日',
      '2025-11-24': '振替休日',
      '2026-01-01': '元日',
      '2026-01-12': '成人の日',
      '2026-02-11': '建国記念の日',
      '2026-02-23': '天皇誕生日',
      '2026-03-20': '春分の日',
      '2026-04-29': '昭和の日',
      '2026-05-03': '憲法記念日',
      '2026-05-04': 'みどりの日',
      '2026-05-05': 'こどもの日',
      '2026-05-06': '振替休日',
      '2026-07-20': '海の日',
      '2026-08-11': '山の日',
      '2026-09-21': '敬老の日',
      '2026-09-22': '国民の休日',
      '2026-09-23': '秋分の日',
      '2026-10-12': 'スポーツの日',
      '2026-11-03': '文化の日',
      '2026-11-23': '勤労感謝の日'
    };

    // データ管理
    const Storage = {
      get: function(key, defaultValue) {
        try {
          const saved = localStorage.getItem('kintai_' + key);
          return saved ? JSON.parse(saved) : defaultValue;
        } catch(e) {
          return defaultValue;
        }
      },
      set: function(key, value) {
        try {
          localStorage.setItem('kintai_' + key, JSON.stringify(value));
        } catch(e) {}
      }
    };

    // 強制リセット（バージョン管理）
    const DATA_VERSION = 'v5_calendar';
    if (localStorage.getItem('kintai_version') !== DATA_VERSION) {
      localStorage.removeItem('kintai_employees');
      localStorage.removeItem('kintai_deletedEmployees');
      localStorage.setItem('kintai_version', DATA_VERSION);
    }

    // アプリ状態
    const App = {
      currentUser: null,
      currentView: 'login',
      employees: Storage.get('employees', [
        { id: '1', name: '椙山 圭', role: 'subadmin', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '2', name: '寺本 亮祐', role: 'subadmin', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '3', name: '椙山 良美', role: 'parttime', dailyRate: 0, hourlyRate: 1200, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '4', name: '松川 大輔', role: 'worker', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '5', name: '松川 敦', role: 'worker', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '6', name: '小関 弘志', role: 'worker', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '7', name: '青山 海斗', role: 'worker', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '8', name: '月精 晃大', role: 'worker', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '9', name: '渡部 直人', role: 'worker', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '10', name: '戸塚 力', role: 'worker', dailyRate: 15000, hourlyRate: 0, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: '11', name: '戸塚 志保', role: 'parttime', dailyRate: 0, hourlyRate: 1200, isActive: true, password: '1234', paidLeaveDate: '' },
        { id: 'admin', name: '戸塚 仁', role: 'admin', dailyRate: 0, hourlyRate: 0, isActive: true, password: 'admin', paidLeaveDate: '' }
      ]),
      jobSites: Storage.get('jobsites', [
        { id: '1', name: 'スーパー三和町田店', address: '東京都町田市', isActive: true, scaffoldingDone: false, completedDate: null },
        { id: '2', name: 'パークシティ横浜', address: '神奈川県横浜市', isActive: true, scaffoldingDone: false, completedDate: null },
        { id: '3', name: 'アトリエうかい', address: '神奈川県横浜市', isActive: true, scaffoldingDone: false, completedDate: null }
      ]),
      records: Storage.get('records', []),
      corrections: Storage.get('corrections', []),
      addressRequests: Storage.get('addressRequests', []),
      deletedEmployees: Storage.get('deletedEmployees', []),
      // 現場日報データ（日付_現場名をキーとして管理）
      siteDailyReports: Storage.get('siteDailyReports', {}),
      // 現場収支データ（現場ID_段階_月をキーとして管理）
      // 段階: scaffolding(足場架け), completion(完工)
      siteFinanceData: Storage.get('siteFinanceData', {}),
      // 管理者からのお知らせ
      announcement: Storage.get('announcement', null),
      gpsLocation: null,
      selectedDate: new Date().toISOString().split('T')[0],
      selectedSiteDate: new Date().toISOString().split('T')[0],
      historyMonth: null,

      save: function() {
        Storage.set('employees', this.employees);
        Storage.set('jobsites', this.jobSites);
        Storage.set('records', this.records);
        Storage.set('corrections', this.corrections);
        Storage.set('addressRequests', this.addressRequests);
        Storage.set('deletedEmployees', this.deletedEmployees);
        Storage.set('siteDailyReports', this.siteDailyReports);
        Storage.set('siteFinanceData', this.siteFinanceData);
        Storage.set('announcement', this.announcement);
      },
      
      // 現場日報のキー生成
      getSiteReportKey: function(date, siteName) {
        return date + '_' + siteName;
      },
      
      // 現場日報を取得
      getSiteDailyReport: function(date, siteName) {
        const key = this.getSiteReportKey(date, siteName);
        return this.siteDailyReports[key] || {
          vendorWorkers: 0,
          contractAmount: 0,
          truckCount: 0,
          subcontractAmount: 0
        };
      },
      
      // 現場日報を保存
      saveSiteDailyReport: function(date, siteName, data) {
        const key = this.getSiteReportKey(date, siteName);
        this.siteDailyReports[key] = data;
        this.save();
      },
      
      // 現場収支キー生成（現場ID_段階_月）
      getSiteFinanceKey: function(siteId, phase, month) {
        return siteId + '_' + phase + '_' + month;
      },
      
      // 現場収支データを取得
      getSiteFinance: function(siteId, phase, month) {
        const key = this.getSiteFinanceKey(siteId, phase, month);
        return this.siteFinanceData[key] || {
          laborCost: 0,         // 人件費（追加分）
          contractAmount: 0,    // 請負金額
          subcontractAmount: 0, // 協力会社発注金額
          truckCount: 0,        // トラック台数
          additionalWorkers: 0, // 追加作業員数
          materialCost: 0       // 材料費
        };
      },
      
      // 現場収支データを保存
      saveSiteFinance: function(siteId, phase, month, data) {
        const key = this.getSiteFinanceKey(siteId, phase, month);
        this.siteFinanceData[key] = data;
        this.save();
      },
      
      // 現場の全月リストを取得
      getSiteFinanceMonths: function(siteId, phase) {
        const months = [];
        Object.keys(this.siteFinanceData).forEach(key => {
          if (key.startsWith(siteId + '_' + phase + '_')) {
            const month = key.split('_')[2];
            if (!months.includes(month)) months.push(month);
          }
        });
        // 勤怠記録からも月を取得
        const site = this.jobSites.find(s => s.id === siteId);
        if (site) {
          this.records.filter(r => r.jobSiteName === site.name).forEach(r => {
            const month = r.workDate.slice(0, 7);
            if (!months.includes(month)) months.push(month);
          });
        }
        return months.sort();
      },
      
      // 類似現場名をチェック（同じ漢字が2文字以上含まれていたら候補を返す）
      findSimilarSite: function(inputName) {
        if (!inputName || inputName.trim() === '') return null;
        
        const input = inputName.trim();
        
        // 入力から漢字を抽出
        const inputKanji = input.match(/[\u4e00-\u9faf]/g) || [];
        if (inputKanji.length < 2) return null; // 漢字2文字未満は対象外
        
        // 共通する漢字の数をカウント
        function countCommonKanji(s1, s2) {
          const kanji1 = s1.match(/[\u4e00-\u9faf]/g) || [];
          const kanji2 = s2.match(/[\u4e00-\u9faf]/g) || [];
          
          if (kanji1.length === 0 || kanji2.length === 0) return 0;
          
          let commonCount = 0;
          const used = new Array(kanji2.length).fill(false);
          
          for (let i = 0; i < kanji1.length; i++) {
            for (let j = 0; j < kanji2.length; j++) {
              if (!used[j] && kanji1[i] === kanji2[j]) {
                commonCount++;
                used[j] = true;
                break;
              }
            }
          }
          return commonCount;
        }
        
        // 既存の現場を順番にチェック（先に登録されたものが先に見つかる）
        for (let i = 0; i < this.jobSites.length; i++) {
          const site = this.jobSites[i];
          // 完全一致は除外
          if (site.name === input) continue;
          
          const commonCount = countCommonKanji(input, site.name);
          if (commonCount >= 2) {
            // 最初に見つかった（＝先に登録された）現場を返す
            return site.name;
          }
        }
        
        return null;
      },

      getToday: function() {
        return new Date().toISOString().split('T')[0];
      },

      getTodayRecord: function() {
        if (!this.currentUser) return null;
        // 今日の「勤務中」の記録を取得（複数回出退勤対応）
        return this.records.find(r => 
          r.employeeId === this.currentUser.id && 
          r.workDate === this.getToday() && 
          r.status === 'working'
        );
      },

      getTodayRecords: function() {
        if (!this.currentUser) return [];
        // 今日の全記録を取得
        return this.records.filter(r => 
          r.employeeId === this.currentUser.id && 
          r.workDate === this.getToday()
        );
      },

      formatTime: function(isoString) {
        if (!isoString) return '--:--';
        return new Date(isoString).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      },

      formatDate: function(dateStr) {
        const date = new Date(dateStr);
        const days = ['日', '月', '火', '水', '木', '金', '土'];
        return (date.getMonth() + 1) + '/' + date.getDate() + '（' + days[date.getDay()] + '）';
      },

      getGreeting: function() {
        const hour = new Date().getHours();
        if (hour < 12) return 'おはようございます';
        if (hour < 18) return 'こんにちは';
        return 'お疲れさまです';
      },

      isHoliday: function(dateStr) {
        return HOLIDAYS[dateStr] || null;
      },

      generateCalendar: function(year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayOfWeek = firstDay.getDay();
        const daysInMonth = lastDay.getDate();
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        // この月の出勤日を取得
        const userId = this.currentUser ? this.currentUser.id : null;
        const workedDates = {};
        if (userId) {
          this.records
            .filter(r => r.employeeId === userId && r.workDate.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`))
            .forEach(r => { workedDates[r.workDate] = true; });
        }
        
        let html = '<div class="mini-calendar">';
        html += `<div class="mini-calendar-header">${year}年${month + 1}月</div>`;
        html += '<div class="mini-calendar-weekdays">';
        ['日', '月', '火', '水', '木', '金', '土'].forEach((d, i) => {
          const cls = i === 0 ? 'sunday' : (i === 6 ? 'saturday' : '');
          html += `<span class="${cls}">${d}</span>`;
        });
        html += '</div>';
        html += '<div class="mini-calendar-days">';
        
        // 前月の空白
        for (let i = 0; i < startDayOfWeek; i++) {
          html += '<span class="empty"></span>';
        }
        
        // 日付
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month, day);
          const dayOfWeek = date.getDay();
          const isToday = dateStr === todayStr;
          const isSunday = dayOfWeek === 0;
          const isSaturday = dayOfWeek === 6;
          const holiday = this.isHoliday(dateStr);
          const worked = workedDates[dateStr];
          
          let cls = [];
          if (isToday) cls.push('today');
          if (isSunday || holiday) cls.push('holiday');
          else if (isSaturday) cls.push('saturday');
          if (worked) cls.push('worked');
          
          html += `<span class="${cls.join(' ')}" ${holiday ? 'title="' + holiday + '"' : ''}>${day}</span>`;
        }
        
        html += '</div></div>';
        return html;
      },

      // プライベート従業員（管理者のみ閲覧可）
      PRIVATE_EMPLOYEE_IDS: ['8', '9'],  // 戸塚力、戸塚志保
      
      // 現場カウント除外リスト
      EXCLUDED_SITES: ['営業', '内勤'],

      getTodayBySite: function(includePrivate) {
        const today = this.getToday();
        let todayRecords = this.records.filter(r => r.workDate === today);
        
        // プライベート従業員をフィルタ（管理者以外の場合）
        if (!includePrivate) {
          todayRecords = todayRecords.filter(r => !this.PRIVATE_EMPLOYEE_IDS.includes(r.employeeId));
        }
        
        const bySite = {};
        todayRecords.forEach(r => {
          if (!bySite[r.jobSiteName]) {
            bySite[r.jobSiteName] = { total: 0, working: 0, workers: [] };
          }
          bySite[r.jobSiteName].total++;
          if (r.status === 'working') bySite[r.jobSiteName].working++;
          bySite[r.jobSiteName].workers.push({
            name: r.employeeName,
            status: r.status,
            clockIn: r.clockInTime,
            clockOut: r.clockOutTime
          });
        });
        return bySite;
      },
      
      // 現場数カウント（営業・内勤を除外）
      countActiveSites: function(bySite) {
        return Object.keys(bySite).filter(name => 
          !this.EXCLUDED_SITES.some(excluded => name.includes(excluded))
        ).length;
      },

      getGPS: function(callback) {
        this.gpsLocation = null;
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              App.gpsLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              if (callback) callback();
            },
            function(error) {
              App.gpsLocation = { lat: 35.4437, lng: 139.6380, accuracy: 50, isDemo: true };
              if (callback) callback();
            }
          );
        } else {
          this.gpsLocation = { lat: 35.4437, lng: 139.6380, accuracy: 50, isDemo: true };
          if (callback) callback();
        }
      }
    };

    // 画面描画
    const Views = {
      render: function(view) {
        App.currentView = view;
        const app = document.getElementById('app');
        app.innerHTML = this[view] ? this[view]() : this.login();
        this.bindEvents(view);
      },

      login: function() {
        return `
          <div class="login-container">
            <div class="logo-section">
              <div class="logo">🏗️</div>
              <h1 class="app-title">勤怠管理</h1>
              <p class="app-subtitle">東京架設</p>
            </div>
            <div>
              <div class="input-group">
                <label class="input-label">従業員ID</label>
                <input type="text" id="loginId" class="login-input" placeholder="例: 1" autocomplete="off" autocapitalize="off" autocorrect="off" inputmode="numeric" pattern="[0-9a-zA-Z]*">
              </div>
              <div class="input-group">
                <label class="input-label">パスワード</label>
                <input type="password" id="loginPassword" class="login-input" placeholder="パスワードを入力" autocomplete="off" inputmode="latin">
              </div>
              <p id="loginError" class="login-error">IDまたはパスワードが正しくありません</p>
              <button id="loginBtn" class="login-btn">ログイン</button>
              <p class="login-hint">※ 初期パスワードは「1234」です（管理者は「admin」）</p>
            </div>
          </div>
        `;
      },

      home: function() {
        const workingRecord = App.getTodayRecord();
        const todayRecords = App.getTodayRecords();
        const completedRecords = todayRecords.filter(r => r.status === 'completed');
        const isWorking = !!workingRecord;
        
        // 今日の日付（曜日付き）
        const today = new Date();
        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
        const todayStr = `${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日（${weekdays[today.getDay()]}）`;
        
        // カレンダー
        const calendarHtml = App.generateCalendar(today.getFullYear(), today.getMonth());
        
        // 有給付与日
        let paidLeaveHtml = '';
        if (App.currentUser.paidLeaveDate) {
          const paidDate = new Date(App.currentUser.paidLeaveDate);
          const paidDateStr = `${paidDate.getFullYear()}年${paidDate.getMonth() + 1}月${paidDate.getDate()}日`;
          const daysUntil = Math.ceil((paidDate - today) / (1000 * 60 * 60 * 24));
          if (daysUntil > 0) {
            paidLeaveHtml = `<div class="paid-leave-info">🎌 次回有給付与日: ${paidDateStr}（あと${daysUntil}日）</div>`;
          } else if (daysUntil === 0) {
            paidLeaveHtml = `<div class="paid-leave-info today">🎉 本日は有給付与日です！</div>`;
          }
        }
        
        let statusHtml = '<p class="status-text">未始業</p>';
        if (isWorking) {
          statusHtml = `
            <p class="status-text">🟢 勤務中</p>
            <p class="status-detail">始業: ${App.formatTime(workingRecord.clockInTime)}</p>
            <p class="status-detail">現場: ${workingRecord.jobSiteName}</p>
          `;
        } else if (completedRecords.length > 0) {
          const lastRecord = completedRecords[completedRecords.length - 1];
          const totalHours = completedRecords.reduce((sum, r) => sum + (r.workHours || 0), 0);
          statusHtml = `
            <p class="status-text">✅ 本日 ${completedRecords.length}回 勤務完了</p>
            <p class="status-otsukare">お疲れさまでした！</p>
            <p class="status-detail">合計勤務時間: ${totalHours.toFixed(1)}時間</p>
            <p class="status-detail">最終: ${App.formatTime(lastRecord.clockInTime)} 〜 ${App.formatTime(lastRecord.clockOutTime)}</p>
            <p class="status-detail">現場: ${lastRecord.jobSiteName}</p>
          `;
        }

        // 今日の勤怠履歴
        let todayHistoryHtml = '';
        if (todayRecords.length > 0) {
          todayHistoryHtml = '<div class="today-history"><p class="section-title">本日の勤怠</p>';
          todayRecords.forEach((r, index) => {
            todayHistoryHtml += `
              <div class="today-record">
                <span class="today-record-num">${index + 1}回目</span>
                <span class="today-record-site">${r.jobSiteName}</span>
                <span class="today-record-time">${App.formatTime(r.clockInTime)} 〜 ${App.formatTime(r.clockOutTime)}</span>
                <span class="today-record-status ${r.status}">${r.status === 'working' ? '勤務中' : '完了'}</span>
                <button class="correction-btn" data-record="${r.id}">修正依頼</button>
              </div>
            `;
          });
          todayHistoryHtml += '</div>';
        }

        // アルバイト向け休憩案内
        let breakInfoHtml = '';
        if (App.currentUser.role === 'parttime') {
          // 年初からの累計計算
          const currentYear = new Date().getFullYear();
          const yearStart = currentYear + '-01-01';
          const yearRecords = App.records.filter(r => 
            r.employeeId === App.currentUser.id && 
            r.workDate >= yearStart && 
            r.status === 'completed'
          );
          
          // 法定休憩を引いた実働時間を計算
          function getBreakHours(workHours) {
            if (workHours <= 6) return 0;
            if (workHours <= 8) return 0.75;
            return 1;
          }
          
          let totalActualHours = 0;
          let estimatedIncome = 0;
          const currentHourlyRate = App.currentUser.hourlyRate || 1200;
          
          yearRecords.forEach(r => {
            const workHours = r.workHours || 0;
            const breakHours = getBreakHours(workHours);
            const actualHours = Math.max(0, workHours - breakHours);
            totalActualHours += actualHours;
            // 記録に時給がある場合はそれを使う（なければ現在の時給）
            const recordRate = r.hourlyRate || currentHourlyRate;
            estimatedIncome += Math.round(actualHours * recordRate);
          });
          
          breakInfoHtml = `
            <div class="income-tracker-card">
              <h3 class="income-tracker-title">💰 ${currentYear}年 収入状況</h3>
              <div class="income-tracker-main">
                <div class="income-tracker-item">
                  <span class="income-tracker-label">累計実働時間</span>
                  <span class="income-tracker-value">${totalActualHours.toFixed(1)}時間</span>
                </div>
                <div class="income-tracker-item highlight">
                  <span class="income-tracker-label">年収見込み</span>
                  <span class="income-tracker-value">¥${estimatedIncome.toLocaleString()}</span>
                </div>
              </div>
              <p class="income-tracker-note">※ 各勤務の時給 × 実働時間（現在の時給: ¥${currentHourlyRate.toLocaleString()}）</p>
            </div>
            
            <div class="income-wall-card">
              <h3 class="income-wall-title">📊 年収の壁（2025年〜）</h3>
              <p class="income-wall-subtitle">出典: 国税庁・厚生労働省</p>
              <div class="income-wall-table">
                <div class="income-wall-row ${estimatedIncome < 1060000 ? 'safe' : 'over'}">
                  <div class="income-wall-left">
                    <span class="income-wall-amount">106万円</span>
                    <span class="income-wall-type">社会保険</span>
                  </div>
                  <div class="income-wall-right">
                    <span class="income-wall-desc">従業員51人以上の企業で週20時間以上勤務の場合、社会保険加入義務が発生</span>
                  </div>
                </div>
                <div class="income-wall-row ${estimatedIncome < 1230000 ? 'safe' : 'over'}">
                  <div class="income-wall-left">
                    <span class="income-wall-amount">123万円</span>
                    <span class="income-wall-type">税制（扶養）</span>
                  </div>
                  <div class="income-wall-right">
                    <span class="income-wall-desc">配偶者控除・扶養控除の上限（2025年〜）</span>
                  </div>
                </div>
                <div class="income-wall-row ${estimatedIncome < 1300000 ? 'safe' : 'over'}">
                  <div class="income-wall-left">
                    <span class="income-wall-amount">130万円</span>
                    <span class="income-wall-type">社会保険</span>
                  </div>
                  <div class="income-wall-right">
                    <span class="income-wall-desc">社会保険の扶養から外れる（国保・国民年金加入）</span>
                  </div>
                </div>
                <div class="income-wall-row ${estimatedIncome < 1600000 ? 'safe' : 'over'}">
                  <div class="income-wall-left">
                    <span class="income-wall-amount">160万円</span>
                    <span class="income-wall-type">所得税</span>
                  </div>
                  <div class="income-wall-right">
                    <span class="income-wall-desc">所得税が発生（基礎控除95万+給与所得控除65万）</span>
                  </div>
                </div>
              </div>
              <p class="income-wall-footer">※ 制度は変更される場合があります。詳細は各機関へご確認ください</p>
            </div>
            
            <div class="break-info-card">
              <h3 class="break-info-title">⏰ 休憩時間の目安（法定）</h3>
              <div class="break-info-table">
                <div class="break-info-row">
                  <span>6時間以下</span>
                  <span>休憩なし</span>
                </div>
                <div class="break-info-row">
                  <span>6時間超〜8時間</span>
                  <span>45分以上</span>
                </div>
                <div class="break-info-row">
                  <span>8時間超</span>
                  <span>60分以上</span>
                </div>
              </div>
              <p class="break-info-note">※ 給与計算時は上記の休憩時間を引いた実働時間で計算されます</p>
            </div>
          `;
        }

        return `
          <div class="header">
            <button id="logoutBtn" class="menu-btn">ログアウト</button>
            <span class="date-text">${todayStr}</span>
            <button id="toggleCalendarBtn" class="calendar-toggle-btn">📅</button>
          </div>
          <div id="calendarPopup" class="calendar-popup hidden">
            ${calendarHtml}
          </div>
          <div class="home-content">
            ${App.announcement ? `<div class="home-announcement"><p class="home-announcement-text">📢 ${App.announcement.message}</p></div>` : ''}
            ${paidLeaveHtml}
            <div class="greeting">
              <p class="greeting-text">${App.getGreeting()}</p>
              <h2 class="user-name">${App.currentUser.name} さん</h2>
            </div>
            <div id="clock" class="clock-display"></div>
            <div class="button-container">
              <button id="clockInBtn" class="main-btn clock-in-btn" ${isWorking ? 'disabled' : ''}>
                <span class="btn-icon">🌅</span>
                <span>出 勤</span>
              </button>
              <button id="clockOutBtn" class="main-btn clock-out-btn" ${!isWorking ? 'disabled' : ''}>
                <span class="btn-icon">🌆</span>
                <span>退 勤</span>
              </button>
            </div>
            <p class="gps-notice">📍 位置情報は打刻時のみ取得・記録されます</p>
            <div class="status-card">
              <h3 class="status-title">本日の状態</h3>
              ${statusHtml}
            </div>
            ${breakInfoHtml}
            ${todayHistoryHtml}
            <div class="home-buttons">
              <button id="historyBtn" class="history-btn">📋 勤怠履歴を見る</button>
              <button id="settingsBtn" class="settings-btn">⚙️ 設定・各種届出</button>
            </div>
          </div>
        `;
      },

      clockIn: function() {
        let siteOptions = '<option value="">-- 既存の現場から選ぶ --</option>';
        App.jobSites.filter(s => s.isActive).forEach(site => {
          siteOptions += `<option value="${site.id}">${site.name}</option>`;
        });

        let gpsHtml = '<p class="gps-loading">位置情報を取得中...</p>';
        if (App.gpsLocation) {
          gpsHtml = `
            <div class="gps-info">
              <p>緯度: ${App.gpsLocation.lat.toFixed(4)}</p>
              <p>経度: ${App.gpsLocation.lng.toFixed(4)}</p>
              <p>精度: ±${Math.round(App.gpsLocation.accuracy)}m</p>
              ${App.gpsLocation.isDemo ? '<p class="demo-text">（デモデータ）</p>' : ''}
            </div>
            <div id="clockInMap" class="map-container"></div>
          `;
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">始業打刻</span>
          </div>
          <div class="form-content">
            <div class="info-row">
              <span class="info-label">従業員</span>
              <span class="info-value">${App.currentUser.name}</span>
            </div>
            <div class="info-row">
              <span class="info-label">日時</span>
              <span class="info-value">${App.formatDate(App.getToday())} ${new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
            <div class="divider"></div>
            <p class="section-title">現場を選択してください</p>
            <select id="jobSiteSelect" class="form-select">${siteOptions}</select>
            <div class="or-divider">
              <span>または</span>
            </div>
            <p class="section-title">🆕 新しい現場を入力</p>
            <input type="text" id="customJobSite" class="form-input" placeholder="例: ○○マンション新築工事">
            <p class="input-hint">※ 入力した現場は次回から選択肢に追加されます</p>
            <div class="divider"></div>
            <div class="gps-section">
              <p class="section-title">📍 現在地</p>
              <div id="gpsInfo">${gpsHtml}</div>
            </div>
            <button id="confirmClockIn" class="confirm-btn" disabled>始業を確定</button>
          </div>
        `;
      },

      clockOut: function() {
        const record = App.getTodayRecord();
        let gpsHtml = '<p class="gps-loading">位置情報を取得中...</p>';
        if (App.gpsLocation) {
          gpsHtml = `
            <div class="gps-info">
              <p>緯度: ${App.gpsLocation.lat.toFixed(4)}</p>
              <p>経度: ${App.gpsLocation.lng.toFixed(4)}</p>
            </div>
            <div id="clockOutMap" class="map-container"></div>
          `;
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">終業打刻</span>
          </div>
          <div class="form-content">
            <div class="info-row">
              <span class="info-label">従業員</span>
              <span class="info-value">${App.currentUser.name}</span>
            </div>
            <div class="info-row">
              <span class="info-label">現場</span>
              <span class="info-value">${record ? record.jobSiteName : ''}</span>
            </div>
            <div class="info-row">
              <span class="info-label">始業時刻</span>
              <span class="info-value">${record ? App.formatTime(record.clockInTime) : ''}</span>
            </div>
            <div class="info-row">
              <span class="info-label">現在時刻</span>
              <span class="info-value">${new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
            <div class="divider"></div>
            <p class="section-title">作業内容メモ（任意）</p>
            <textarea id="workMemo" class="form-textarea" placeholder="本日の作業内容を入力"></textarea>
            <div class="gps-section">
              <p class="section-title">📍 現在地</p>
              <div id="gpsInfo">${gpsHtml}</div>
            </div>
            <button id="confirmClockOut" class="confirm-btn">終業を確定</button>
          </div>
        `;
      },

      settings: function() {
        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">設定・各種届出</span>
          </div>
          <div class="list-content">
            <div class="settings-section">
              <h3 class="settings-section-title">アカウント設定</h3>
              
              <div class="settings-card">
                <h4 class="settings-card-title">🆔 ID変更</h4>
                <p class="settings-card-desc">現在のID: ${App.currentUser.id}</p>
                <div class="settings-input-group">
                  <input type="text" id="newIdInput" class="settings-input" placeholder="新しいID">
                  <button id="changeIdBtn" class="settings-save-btn">変更</button>
                </div>
              </div>
              
              <div class="settings-card">
                <h4 class="settings-card-title">🔑 パスワード変更</h4>
                <div class="settings-input-group">
                  <input type="password" id="currentPasswordInput" class="settings-input" placeholder="現在のパスワード">
                </div>
                <div class="settings-input-group">
                  <input type="password" id="newPasswordInput" class="settings-input" placeholder="新しいパスワード">
                </div>
                <div class="settings-input-group">
                  <input type="password" id="confirmPasswordInput" class="settings-input" placeholder="新しいパスワード（確認）">
                  <button id="changePasswordBtn" class="settings-save-btn">変更</button>
                </div>
              </div>
            </div>
            
            <div class="settings-section">
              <h3 class="settings-section-title">届出</h3>
              
              <div class="settings-card">
                <h4 class="settings-card-title">🏠 住所変更届</h4>
                <p class="settings-card-desc">住所が変わった場合はこちらから届出してください</p>
                <div class="settings-input-group">
                  <input type="text" id="newAddressInput" class="settings-input" placeholder="新しい住所を入力">
                  <button id="submitAddressBtn" class="settings-save-btn">届出</button>
                </div>
                <p class="settings-card-note">※ 届出内容は管理者が確認後、削除されます</p>
              </div>
            </div>
          </div>
        `;
      },

      adminSettings: function() {
        const backView = App.currentUser.role === 'admin' ? 'admin' : 'subadmin';
        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">ID・パスワード変更</span>
          </div>
          <div class="list-content">
            <div class="settings-section">
              <h3 class="settings-section-title">アカウント設定</h3>
              
              <div class="settings-card">
                <h4 class="settings-card-title">🆔 ID変更</h4>
                <p class="settings-card-desc">現在のID: ${App.currentUser.id}</p>
                <div class="settings-input-group">
                  <input type="text" id="newIdInput" class="settings-input" placeholder="新しいID">
                  <button id="changeIdBtn" class="settings-save-btn">変更</button>
                </div>
              </div>
              
              <div class="settings-card">
                <h4 class="settings-card-title">🔑 パスワード変更</h4>
                <div class="settings-input-group">
                  <input type="password" id="currentPasswordInput" class="settings-input" placeholder="現在のパスワード">
                </div>
                <div class="settings-input-group">
                  <input type="password" id="newPasswordInput" class="settings-input" placeholder="新しいパスワード">
                </div>
                <div class="settings-input-group">
                  <input type="password" id="confirmPasswordInput" class="settings-input" placeholder="新しいパスワード（確認）">
                  <button id="changePasswordBtn" class="settings-save-btn">変更</button>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      history: function() {
        // 選択中の月（デフォルトは今月）
        const selectedMonth = App.historyMonth || new Date().toISOString().slice(0, 7);
        
        // この従業員の全記録から月のリストを作成
        const allRecords = App.records.filter(r => r.employeeId === App.currentUser.id);
        const months = [...new Set(allRecords.map(r => r.workDate.slice(0, 7)))].sort().reverse();
        
        // 今月がリストになければ追加
        const currentMonth = new Date().toISOString().slice(0, 7);
        if (!months.includes(currentMonth)) {
          months.unshift(currentMonth);
        }
        
        // 選択月の記録
        const records = allRecords
          .filter(r => r.workDate.startsWith(selectedMonth))
          .sort((a, b) => new Date(b.workDate) - new Date(a.workDate));
        
        // 月選択セレクトボックス
        let monthOptions = '';
        months.forEach(m => {
          const [y, mo] = m.split('-');
          const label = `${y}年${parseInt(mo)}月`;
          monthOptions += `<option value="${m}" ${m === selectedMonth ? 'selected' : ''}>${label}</option>`;
        });
        
        // 月の集計
        const completedRecords = records.filter(r => r.status === 'completed');
        const totalDays = completedRecords.length;
        const totalHours = completedRecords.reduce((sum, r) => sum + (r.workHours || 0), 0);
        
        let recordsHtml = '';
        if (records.length === 0) {
          recordsHtml = '<p class="empty-text">この月の勤怠記録がありません</p>';
        } else {
          records.forEach(r => {
            const date = new Date(r.workDate);
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            const dateStr = `${date.getMonth() + 1}/${date.getDate()}（${weekdays[date.getDay()]}）`;
            recordsHtml += `
              <div class="record-card">
                <div class="record-header">
                  <span class="record-date">${dateStr}</span>
                  <span class="record-status ${r.status}">${r.status === 'working' ? '勤務中' : '完了'}</span>
                </div>
                <p class="record-site">🏗️ ${r.jobSiteName}</p>
                <p class="record-time">${App.formatTime(r.clockInTime)} 〜 ${App.formatTime(r.clockOutTime)}${r.workHours ? ' （' + r.workHours.toFixed(1) + 'h）' : ''}</p>
                ${r.memo ? '<p class="record-memo">📝 ' + r.memo + '</p>' : ''}
              </div>
            `;
          });
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">勤怠履歴</span>
          </div>
          <div class="list-content">
            <div class="month-selector">
              <select id="historyMonthSelect" class="month-select">
                ${monthOptions}
              </select>
            </div>
            <div class="month-summary">
              <div class="month-summary-item">
                <span class="month-summary-label">始業日数</span>
                <span class="month-summary-value">${totalDays}日</span>
              </div>
              <div class="month-summary-item">
                <span class="month-summary-label">合計勤務時間</span>
                <span class="month-summary-value">${totalHours.toFixed(1)}時間</span>
              </div>
            </div>
            ${recordsHtml}
          </div>
        `;
      },

      admin: function() {
        const bySite = App.getTodayBySite(true); // 管理者は全員表示
        const siteNames = Object.keys(bySite);
        let totalWorkers = 0;
        siteNames.forEach(name => { totalWorkers += bySite[name].total; });
        
        // 現場数（営業・内勤を除く）
        const activeSiteCount = App.countActiveSites(bySite);

        // 未処理の修正依頼数
        const pendingCorrections = App.corrections.filter(c => c.status === 'pending').length;

        // 今日の自分の勤怠（管理者も出退勤可能に）
        const myTodayRecords = App.records.filter(r => 
          r.employeeId === App.currentUser.id && 
          r.workDate === App.getToday()
        );
        const isWorking = myTodayRecords.some(r => r.status === 'working');

        return `
          <div class="header">
            <button id="logoutBtn" class="menu-btn">ログアウト</button>
            <span class="header-title">管理者メニュー</span>
          </div>
          <div class="admin-content">
            <p class="admin-date">${App.formatDate(App.getToday())}</p>
            
            <div class="admin-clockin-section">
              <p class="admin-greeting">${App.currentUser.name} さん</p>
              <div class="admin-buttons">
                <button id="adminClockIn" class="admin-btn clock-in" ${isWorking ? 'disabled' : ''}>
                  🌅 始業
                </button>
                <button id="adminClockOut" class="admin-btn clock-out" ${!isWorking ? 'disabled' : ''}>
                  🌆 終業
                </button>
              </div>
            </div>
            
            <div class="stats-container">
              <div class="stat-card">
                <span class="stat-number">${totalWorkers}</span>
                <span class="stat-label">本日勤務人数</span>
              </div>
              <div class="stat-card">
                <span class="stat-number">${activeSiteCount}</span>
                <span class="stat-label">稼働現場数</span>
              </div>
              <div class="stat-card ${pendingCorrections > 0 ? 'alert' : ''}">
                <span class="stat-number">${pendingCorrections}</span>
                <span class="stat-label">編集依頼</span>
              </div>
            </div>
            <div class="menu-section">
              <h3 class="section-title">メニュー</h3>
              <div class="menu-grid">
                <button class="menu-card" data-view="dailyList">
                  <span class="menu-icon">📅</span>
                  <span>出勤一覧</span>
                </button>
                <button class="menu-card" data-view="siteList">
                  <span class="menu-icon">🏗️</span>
                  <span>稼働現場一覧</span>
                </button>
                <button class="menu-card" data-view="completedSiteList">
                  <span class="menu-icon">✅</span>
                  <span>終了現場</span>
                </button>
                <button class="menu-card" data-view="siteFinance">
                  <span class="menu-icon">💰</span>
                  <span>各現場収支</span>
                </button>
                <button class="menu-card" data-view="employeeMaster">
                  <span class="menu-icon">👤</span>
                  <span>従業員マスタ</span>
                </button>
                <button class="menu-card" data-view="siteMaster">
                  <span class="menu-icon">🏢</span>
                  <span>現場マスタ</span>
                </button>
                <button class="menu-card ${pendingCorrections > 0 ? 'has-alert' : ''}" data-view="correctionList">
                  <span class="menu-icon">📝</span>
                  <span>出退勤誤入力編集依頼${pendingCorrections > 0 ? '（' + pendingCorrections + '件）' : ''}</span>
                </button>
                <button class="menu-card ${App.addressRequests.length > 0 ? 'has-alert' : ''}" data-view="addressRequestList">
                  <span class="menu-icon">🏠</span>
                  <span>住所変更届${App.addressRequests.length > 0 ? '（' + App.addressRequests.length + '件）' : ''}</span>
                </button>
                <button class="menu-card" data-view="csvExport">
                  <span class="menu-icon">📊</span>
                  <span>CSVエクスポート</span>
                </button>
                <button class="menu-card" data-view="dataManagement">
                  <span class="menu-icon">💾</span>
                  <span>データ管理</span>
                </button>
                <button class="menu-card ${App.announcement ? 'has-alert' : ''}" data-view="announcement">
                  <span class="menu-icon">📢</span>
                  <span>お知らせ送信${App.announcement ? '（配信中）' : ''}</span>
                </button>
              </div>
              
              <div class="announcement-section">
                <h3 class="announcement-title">📢 全員へお知らせ</h3>
                ${App.announcement ? `
                  <div class="current-announcement">
                    <p class="current-announcement-text">${App.announcement.message}</p>
                    <p class="current-announcement-date">送信: ${new Date(App.announcement.createdAt).toLocaleString('ja-JP')}</p>
                    <button id="cancelAnnouncement" class="cancel-announcement-btn">取り消し</button>
                  </div>
                ` : `
                  <div class="announcement-form">
                    <input type="text" id="announcementInput" class="announcement-input" placeholder="メッセージを入力...">
                    <button id="sendAnnouncement" class="send-announcement-btn">送信</button>
                  </div>
                `}
              </div>
              
              <button class="menu-card-wide" data-view="adminSettings">
                <span class="menu-icon">⚙️</span>
                <span>ID・パスワード変更</span>
              </button>
            </div>
          </div>
        `;
      },

      subadmin: function() {
        const bySite = App.getTodayBySite(false); // 副管理者はプライベート除外
        const siteNames = Object.keys(bySite);
        let totalWorkers = 0;
        siteNames.forEach(name => { totalWorkers += bySite[name].total; });
        
        // 現場数（営業・内勤を除く）
        const activeSiteCount = App.countActiveSites(bySite);

        // 未処理の修正依頼数
        const pendingCorrections = App.corrections.filter(c => c.status === 'pending').length;

        // 今日の自分の勤怠
        const myTodayRecords = App.records.filter(r => 
          r.employeeId === App.currentUser.id && 
          r.workDate === App.getToday()
        );
        const isWorking = myTodayRecords.some(r => r.status === 'working');

        return `
          <div class="header">
            <button id="logoutBtn" class="menu-btn">ログアウト</button>
            <span class="header-title">管理者（副）メニュー</span>
          </div>
          <div class="admin-content">
            ${App.announcement ? `<div class="home-announcement"><p class="home-announcement-text">📢 ${App.announcement.message}</p></div>` : ''}
            <p class="admin-date">${App.formatDate(App.getToday())}</p>
            
            <div class="subadmin-clockin-section">
              <p class="subadmin-greeting">${App.currentUser.name} さん</p>
              <div class="subadmin-buttons">
                <button id="subadminClockIn" class="subadmin-btn clock-in" ${isWorking ? 'disabled' : ''}>
                  🌅 始業
                </button>
                <button id="subadminClockOut" class="subadmin-btn clock-out" ${!isWorking ? 'disabled' : ''}>
                  🌆 終業
                </button>
              </div>
            </div>
            
            <div class="stats-container">
              <div class="stat-card">
                <span class="stat-number">${totalWorkers}</span>
                <span class="stat-label">本日勤務人数</span>
              </div>
              <div class="stat-card">
                <span class="stat-number">${activeSiteCount}</span>
                <span class="stat-label">稼働現場数</span>
              </div>
              <div class="stat-card ${pendingCorrections > 0 ? 'alert' : ''}">
                <span class="stat-number">${pendingCorrections}</span>
                <span class="stat-label">編集依頼</span>
              </div>
            </div>
            <div class="menu-section">
              <h3 class="section-title">メニュー</h3>
              <div class="menu-grid">
                <button class="menu-card" data-view="dailyList">
                  <span class="menu-icon">📅</span>
                  <span>出勤一覧</span>
                </button>
                <button class="menu-card" data-view="siteList">
                  <span class="menu-icon">🏗️</span>
                  <span>稼働現場一覧</span>
                </button>
                <button class="menu-card" data-view="completedSiteList">
                  <span class="menu-icon">✅</span>
                  <span>終了現場</span>
                </button>
                <button class="menu-card" data-view="siteFinance">
                  <span class="menu-icon">💰</span>
                  <span>各現場収支</span>
                </button>
                <button class="menu-card ${pendingCorrections > 0 ? 'has-alert' : ''}" data-view="correctionList">
                  <span class="menu-icon">📝</span>
                  <span>出退勤誤入力編集依頼${pendingCorrections > 0 ? '（' + pendingCorrections + '件）' : ''}</span>
                </button>
                <button class="menu-card" data-view="csvExport">
                  <span class="menu-icon">📊</span>
                  <span>CSVエクスポート</span>
                </button>
              </div>
              <button class="menu-card-wide" data-view="adminSettings">
                <span class="menu-icon">⚙️</span>
                <span>ID・パスワード変更</span>
              </button>
            </div>
          </div>
        `;
      },

      dailyList: function() {
        // プライベート従業員を除外するかどうか
        const isAdmin = App.currentUser.role === 'admin';
        let records = App.records.filter(r => r.workDate === App.selectedDate);
        
        // 副管理者の場合はプライベート従業員を除外
        if (!isAdmin) {
          records = records.filter(r => !App.PRIVATE_EMPLOYEE_IDS.includes(r.employeeId));
        }
        
        // 全従業員の出勤状況を作成（管理者も含む）
        let activeEmployees = App.employees.filter(e => e.isActive);
        if (!isAdmin) {
          activeEmployees = activeEmployees.filter(e => !App.PRIVATE_EMPLOYEE_IDS.includes(e.id));
        }
        
        let gridHtml = '<div class="attendance-grid">';
        activeEmployees.forEach(emp => {
          const empRecords = records.filter(r => r.employeeId === emp.id);
          const hasRecord = empRecords.length > 0;
          
          if (!hasRecord) {
            // 未始業
            gridHtml += `
              <div class="attendance-cell absent">
                <span class="attendance-name">${emp.name}</span>
                <span class="attendance-mark">✕</span>
              </div>
            `;
          } else {
            // 出勤あり - 各記録をマークとして表示
            let marksHtml = '';
            let allCompleted = true;
            empRecords.forEach((r, idx) => {
              const isNight = r.shiftType === 'night';
              const isCompleted = r.status === 'completed';
              if (!isCompleted) allCompleted = false;
              const markClass = isCompleted ? 'completed' : 'working';
              marksHtml += `
                <span class="attendance-mark-item ${markClass}" data-record-id="${r.id}">
                  <span class="mark-circle">◯</span>
                  <span class="mark-shift">${isNight ? '夜' : '昼'}</span>
                  ${isCompleted ? '<span class="mark-done">終了</span>' : ''}
                </span>
              `;
            });
            
            // 最新の現場名を短縮表示
            const latestRecord = empRecords[empRecords.length - 1];
            const siteName = latestRecord.jobSiteName;
            const shortSiteName = siteName.length > 6 ? siteName.substring(0, 6) + '…' : siteName;
            
            gridHtml += `
              <div class="attendance-cell present ${allCompleted ? 'all-completed' : ''}" data-emp-id="${emp.id}">
                <span class="attendance-name">${emp.name}</span>
                <div class="attendance-marks">${marksHtml}</div>
                <span class="attendance-site">${shortSiteName}</span>
              </div>
            `;
          }
        });
        gridHtml += '</div>';
        
        // 始業者数
        const presentCount = activeEmployees.filter(emp => 
          records.some(r => r.employeeId === emp.id)
        ).length;

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">出勤一覧</span>
          </div>
          <div class="list-content">
            <input type="date" id="dateSelect" class="date-input" value="${App.selectedDate}">
            <div class="attendance-summary">
              <span class="attendance-date">${App.formatDate(App.selectedDate)}</span>
              <span class="attendance-count">始業: ${presentCount}/${activeEmployees.length}名</span>
            </div>
            ${gridHtml}
          </div>
          <div id="attendanceDetailModal" class="attendance-detail-modal hidden">
            <div class="attendance-detail-content">
              <button class="attendance-detail-close" id="closeDetailModal">✕</button>
              <div id="attendanceDetailBody"></div>
            </div>
          </div>
          <div id="mapModal" class="map-modal hidden">
            <div class="map-modal-header">
              <span class="map-modal-title" id="mapModalTitle">打刻場所</span>
              <button class="map-modal-close" id="closeMapModal">✕</button>
            </div>
            <div class="map-modal-body">
              <div id="modalMap"></div>
            </div>
            <div class="map-info" id="mapModalInfo"></div>
          </div>
        `;
      },

      siteList: function() {
        const selectedDate = App.selectedSiteDate;
        const isAdmin = App.currentUser.role === 'admin';
        
        // 選択日の記録を取得
        let dayRecords = App.records.filter(r => r.workDate === selectedDate);
        if (!isAdmin) {
          dayRecords = dayRecords.filter(r => !App.PRIVATE_EMPLOYEE_IDS.includes(r.employeeId));
        }
        
        // 現場ごとにグループ化
        const bySite = {};
        dayRecords.forEach(r => {
          if (!bySite[r.jobSiteName]) {
            bySite[r.jobSiteName] = { total: 0, working: 0, workers: [] };
          }
          bySite[r.jobSiteName].total++;
          if (r.status === 'working') bySite[r.jobSiteName].working++;
          bySite[r.jobSiteName].workers.push({
            name: r.employeeName,
            status: r.status,
            clockIn: r.clockInTime,
            clockOut: r.clockOutTime
          });
        });
        
        // 稼働中現場と終了現場を分ける（営業・内勤は除外）
        const activeSites = App.jobSites.filter(s => 
          s.isActive && !s.completedDate && !App.EXCLUDED_SITES.some(ex => s.name.includes(ex))
        );
        const completedSites = App.jobSites.filter(s => 
          s.isActive && s.completedDate && !App.EXCLUDED_SITES.some(ex => s.name.includes(ex))
        );
        
        // 稼働中現場グリッドHTML
        let activeGridHtml = '<div class="site-grid">';
        if (activeSites.length === 0) {
          activeGridHtml += '<p class="empty-text">稼働中の現場はありません</p>';
        } else {
          activeSites.forEach(site => {
            const data = bySite[site.name];
            const hasWorkers = data && data.total > 0;
            const allCompleted = hasWorkers && data.working === 0;
            
            activeGridHtml += `
              <div class="site-cell ${hasWorkers ? 'active' : 'inactive'} ${allCompleted ? 'all-completed' : ''}" 
                   data-site-name="${site.name}" data-site-id="${site.id}">
                <span class="site-cell-name">${site.name}</span>
                <span class="site-cell-mark">${hasWorkers ? '◯' : '✕'}</span>
                ${hasWorkers ? `<span class="site-cell-count">${data.total}名</span>` : ''}
                ${site.scaffoldingDone ? '<span class="site-scaffolding-badge">架け済</span>' : ''}
              </div>
            `;
          });
        }
        activeGridHtml += '</div>';
        
        // 稼働現場数（営業・内勤除く、完工除く）
        const activeSiteCount = Object.keys(bySite).filter(name => {
          const site = App.jobSites.find(s => s.name === name);
          return !App.EXCLUDED_SITES.some(ex => name.includes(ex)) && site && !site.completedDate;
        }).length;

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">稼働現場一覧</span>
          </div>
          <div class="list-content">
            <input type="date" id="siteDateSelect" class="date-input" value="${selectedDate}">
            <div class="attendance-summary">
              <span class="attendance-date">${App.formatDate(selectedDate)}</span>
              <span class="attendance-count">稼働現場: ${activeSiteCount}件</span>
            </div>
            
            <div class="site-section">
              <h3 class="site-section-title">🏗️ 稼働中現場（${activeSites.length}件）</h3>
              ${activeGridHtml}
            </div>
          </div>
          <div id="siteDetailModal" class="site-detail-modal hidden">
            <div class="site-detail-modal-content">
              <button class="site-detail-modal-close" id="closeSiteDetailModal">✕</button>
              <div id="siteDetailBody"></div>
            </div>
          </div>
        `;
      },

      completedSiteList: function() {
        // 終了現場（営業・内勤除外）
        const completedSites = App.jobSites.filter(s => 
          s.isActive && s.completedDate && !App.EXCLUDED_SITES.some(ex => s.name.includes(ex))
        );
        
        let gridHtml = '<div class="site-grid">';
        if (completedSites.length === 0) {
          gridHtml = '<p class="empty-text">終了した現場はありません</p>';
        } else {
          completedSites.forEach(site => {
            gridHtml += `
              <div class="site-cell completed-site" data-site-id="${site.id}" data-site-name="${site.name}">
                <span class="site-cell-name">${site.name}</span>
                <span class="site-cell-mark">✓</span>
                <span class="site-cell-date">${site.completedDate}</span>
              </div>
            `;
          });
          gridHtml += '</div>';
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">終了現場</span>
          </div>
          <div class="list-content">
            <div class="attendance-summary">
              <span class="attendance-count">終了現場: ${completedSites.length}件</span>
            </div>
            ${gridHtml}
          </div>
          <div id="siteDetailModal" class="site-detail-modal hidden">
            <div class="site-detail-modal-content">
              <button class="site-detail-modal-close" id="closeSiteDetailModal">✕</button>
              <div id="siteDetailBody"></div>
            </div>
          </div>
        `;
      },

      siteFinance: function() {
        // 全現場（営業・内勤除外）
        const allSites = App.jobSites.filter(s => 
          s.isActive && !App.EXCLUDED_SITES.some(ex => s.name.includes(ex))
        );
        
        let sitesHtml = '';
        allSites.forEach(site => {
          const statusBadge = site.completedDate 
            ? '<span class="finance-status completed">完工</span>' 
            : (site.scaffoldingDone ? '<span class="finance-status scaffolding">架け済</span>' : '<span class="finance-status active">稼働中</span>');
          
          sitesHtml += `
            <div class="finance-card-link" data-site-id="${site.id}">
              <div class="finance-header">
                <span class="finance-site-name">${site.name}</span>
                ${statusBadge}
              </div>
              <div class="finance-link-text">タップして詳細を見る →</div>
            </div>
          `;
        });

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">各現場収支</span>
          </div>
          <div class="list-content">
            ${sitesHtml || '<p class="empty-text">現場がありません</p>'}
          </div>
        `;
      },
      
      siteFinanceDetail: function() {
        const site = App.jobSites.find(s => s.id === App.selectedSiteId);
        if (!site) return '<p class="empty-text">現場が見つかりません</p>';
        
        const LABOR_COST_PER_DAY = 25000;
        const TRUCK_COST_PER_UNIT = 25000;
        
        // 勤怠記録から自動人件費を計算
        const allRecords = App.records.filter(r => r.jobSiteName === site.name);
        const autoLaborCost = allRecords.length * LABOR_COST_PER_DAY;
        
        // 日報データから協力会社・トラックを集計
        let dailySubcontract = 0;
        let dailyTruckCount = 0;
        Object.keys(App.siteDailyReports).forEach(key => {
          if (key.endsWith('_' + site.name)) {
            const report = App.siteDailyReports[key];
            dailySubcontract += report.subcontractAmount || 0;
            dailyTruckCount += report.truckCount || 0;
          }
        });
        const dailyTruckCost = dailyTruckCount * TRUCK_COST_PER_UNIT;
        
        // 総計データ
        const totalData = App.getSiteFinance(site.id, 'total', 'all');
        const scaffoldingData = App.getSiteFinance(site.id, 'scaffolding', 'all');
        const completionData = App.getSiteFinance(site.id, 'completion', 'all');
        
        // 材料費データ（月ごと）
        const materialMonths = totalData.materialMonths || [];
        let totalMaterialCost = 0;
        materialMonths.forEach(m => {
          totalMaterialCost += (m.basicCost || 0) + (m.rentalCost || 0);
        });
        
        // 材料費月ごとHTML
        let materialMonthsHtml = '';
        materialMonths.forEach((m, idx) => {
          materialMonthsHtml += `
            <div class="material-month-item">
              <span>${m.month}</span>
              <span>基本¥${(m.basicCost||0).toLocaleString()} 賃貸¥${(m.rentalCost||0).toLocaleString()}</span>
              <button class="material-del-btn" data-idx="${idx}">✕</button>
            </div>
          `;
        });
        
        // 費用計算
        const additionalLabor = totalData.laborCost || 0;
        const additionalSubcontract = totalData.subcontractAmount || 0;
        const additionalTruckCount = totalData.truckCount || 0;
        const additionalTruckCost = additionalTruckCount * TRUCK_COST_PER_UNIT;
        
        const totalContract = totalData.contractAmount || 0;
        const totalCost = autoLaborCost + additionalLabor + dailySubcontract + additionalSubcontract + dailyTruckCost + additionalTruckCost + totalMaterialCost;
        const profit = totalContract - totalCost;
        const profitRate = totalContract > 0 ? ((profit / totalContract) * 100).toFixed(1) : 0;
        const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">現場収支</span>
          </div>
          <div class="list-content">
            <div class="finance-top-summary">
              <div class="finance-top-name">${site.name}</div>
              <div class="finance-top-row">
                <span>収支</span>
                <span class="${profitClass}">${profit >= 0 ? '+' : ''}¥${profit.toLocaleString()}</span>
              </div>
              <div class="finance-top-row">
                <span>収益率</span>
                <span class="${profitClass}">${profitRate}%</span>
              </div>
            </div>
            
            <!-- 総計アコーディオン -->
            <div class="accordion-item open" data-section="total">
              <div class="accordion-header" data-section="total">
                <span>▼ 総計</span>
              </div>
              <div class="accordion-body" id="accordionTotal">
                <div class="acc-row">
                  <label>請負金額</label>
                  <input type="number" id="totalContract" class="acc-input" value="${totalContract}">
                  <span>円</span>
                </div>
                <div class="acc-row display">
                  <span>👷人件費 勤怠(${allRecords.length}人)</span>
                  <span>¥${autoLaborCost.toLocaleString()}</span>
                </div>
                <div class="acc-row">
                  <label>👷追加</label>
                  <input type="number" id="additionalLabor" class="acc-input" value="${additionalLabor}">
                  <span>円</span>
                </div>
                <div class="acc-row display">
                  <span>🏢協力会社 日報分</span>
                  <span>¥${dailySubcontract.toLocaleString()}</span>
                </div>
                <div class="acc-row">
                  <label>🏢追加</label>
                  <input type="number" id="additionalSubcontract" class="acc-input" value="${additionalSubcontract}">
                  <span>円</span>
                </div>
                <div class="acc-row display">
                  <span>🚚トラック 日報(${dailyTruckCount}台)</span>
                  <span>¥${dailyTruckCost.toLocaleString()}</span>
                </div>
                <div class="acc-row">
                  <label>🚚追加</label>
                  <input type="number" id="additionalTruck" class="acc-input" value="${additionalTruckCount}">
                  <span>台</span>
                </div>
                <div class="acc-material-section">
                  <div class="acc-material-header">
                    <span>📦材料費 計¥${totalMaterialCost.toLocaleString()}</span>
                    <button class="acc-add-btn" id="addMaterialMonth">＋</button>
                  </div>
                  <div id="materialMonthsList">
                    ${materialMonthsHtml || '<span class="acc-empty">月を追加してください</span>'}
                  </div>
                </div>
                <button class="acc-save-btn" id="saveTotalBtn">💾 保存</button>
              </div>
            </div>
            
            <!-- 足場架けアコーディオン -->
            <div class="accordion-item" data-section="scaffolding">
              <div class="accordion-header" data-section="scaffolding">
                <span>▶ 足場架け</span>
              </div>
              <div class="accordion-body hidden" id="accordionScaffolding">
                <div class="acc-row">
                  <label>請負金額</label>
                  <input type="number" id="scaffoldingContract" class="acc-input" value="${scaffoldingData.contractAmount || 0}">
                  <span>円</span>
                </div>
                <div class="acc-row">
                  <label>追加人件費</label>
                  <input type="number" id="scaffoldingLabor" class="acc-input" value="${scaffoldingData.laborCost || 0}">
                  <span>円</span>
                </div>
                <button class="acc-save-btn" id="saveScaffoldingBtn">💾 保存</button>
              </div>
            </div>
            
            <!-- 完工アコーディオン -->
            <div class="accordion-item ${!site.completedDate ? 'disabled' : ''}" data-section="completion">
              <div class="accordion-header" data-section="completion">
                <span>▶ 完工${!site.completedDate ? '（未完工）' : ''}</span>
              </div>
              <div class="accordion-body hidden" id="accordionCompletion">
                ${site.completedDate ? `
                  <div class="acc-row">
                    <label>請負金額</label>
                    <input type="number" id="completionContract" class="acc-input" value="${completionData.contractAmount || 0}">
                    <span>円</span>
                  </div>
                  <div class="acc-row">
                    <label>追加人件費</label>
                    <input type="number" id="completionLabor" class="acc-input" value="${completionData.laborCost || 0}">
                    <span>円</span>
                  </div>
                  <button class="acc-save-btn" id="saveCompletionBtn">💾 保存</button>
                ` : '<p class="acc-empty">完工後に入力できます</p>'}
              </div>
            </div>
          </div>
          
          <!-- 材料費追加モーダル -->
          <div id="materialModal" class="site-detail-modal hidden">
            <div class="site-detail-modal-content">
              <button class="site-detail-modal-close" id="closeMaterialModal">✕</button>
              <h3 class="site-detail-title">📦 材料費を追加</h3>
              <div class="site-report-input-group">
                <label class="site-report-label">月（例: 2026年1月）</label>
                <input type="text" id="materialMonth" class="site-report-input" placeholder="2026年1月">
              </div>
              <div class="site-report-input-group">
                <label class="site-report-label">基本料（円）</label>
                <input type="number" id="materialBasic" class="site-report-input" value="0">
              </div>
              <div class="site-report-input-group">
                <label class="site-report-label">賃貸料（円）</label>
                <input type="number" id="materialRental" class="site-report-input" value="0">
              </div>
              <button class="site-report-save-btn" id="saveMaterialMonth">追加</button>
            </div>
          </div>
        `;
      },

      employeeMaster: function() {
        let employeesHtml = '';
        App.employees.filter(e => e.id !== 'admin').forEach(emp => {
          const isParttime = emp.role === 'parttime';
          const isSubadmin = emp.role === 'subadmin';
          const roleText = emp.role === 'worker' ? '作業員' : (emp.role === 'manager' ? '責任者' : (emp.role === 'subadmin' ? '管理者（副）' : 'アルバイト'));
          const rateLabel = isParttime ? '時給' : '日当';
          const rateValue = isParttime ? (emp.hourlyRate || 1200) : (emp.dailyRate || 15000);
          
          employeesHtml += `
            <div class="master-card" data-id="${emp.id}">
              <div class="master-header">
                <span class="master-name">
                  <span class="employee-id-badge">ID: ${emp.id}</span>
                  ${emp.name}
                </span>
                <span class="role-badge ${emp.role}">${roleText}</span>
              </div>
              <button class="toggle-btn ${emp.isActive ? 'active' : 'inactive'}" data-emp="${emp.id}">${emp.isActive ? '有効' : '無効'}</button>
              
              <div class="edit-section">
                <div class="edit-row">
                  <label class="edit-label">ID</label>
                  <div class="edit-input-group">
                    <input type="text" class="edit-input id-input" data-emp="${emp.id}" value="${emp.id}">
                    <button class="edit-save-btn save-id-btn" data-emp="${emp.id}">変更</button>
                  </div>
                </div>
                
                <div class="edit-row">
                  <label class="edit-label">名前</label>
                  <div class="edit-input-group">
                    <input type="text" class="edit-input name-input" data-emp="${emp.id}" value="${emp.name}">
                    <button class="edit-save-btn save-name-btn" data-emp="${emp.id}">変更</button>
                  </div>
                </div>
                
                <div class="edit-row">
                  <label class="edit-label">役割</label>
                  <div class="edit-input-group">
                    <select class="edit-select role-select" data-emp="${emp.id}">
                      <option value="worker" ${emp.role === 'worker' ? 'selected' : ''}>作業員（日当）</option>
                      <option value="manager" ${emp.role === 'manager' ? 'selected' : ''}>責任者（日当）</option>
                      <option value="parttime" ${emp.role === 'parttime' ? 'selected' : ''}>アルバイト（時給）</option>
                      <option value="subadmin" ${emp.role === 'subadmin' ? 'selected' : ''}>管理者（副）</option>
                    </select>
                    <button class="edit-save-btn save-role-btn" data-emp="${emp.id}">変更</button>
                  </div>
                </div>
                
                <div class="edit-row rate-row" data-emp="${emp.id}">
                  <label class="edit-label rate-label">${rateLabel}</label>
                  <div class="edit-input-group">
                    <input type="number" class="edit-input rate-input" data-emp="${emp.id}" value="${rateValue}">
                    <button class="edit-save-btn save-rate-btn" data-emp="${emp.id}">変更</button>
                  </div>
                </div>
                
                <div class="edit-row">
                  <label class="edit-label">有給付与日</label>
                  <div class="edit-input-group">
                    <input type="date" class="edit-input paid-leave-input" data-emp="${emp.id}" value="${emp.paidLeaveDate || ''}">
                    <button class="edit-save-btn save-paid-leave-btn" data-emp="${emp.id}">変更</button>
                  </div>
                </div>
              </div>
              
              <div class="password-section">
                <div class="password-row">
                  <span class="password-label">パスワード:</span>
                  <span class="password-value" data-emp="${emp.id}">••••</span>
                  <button class="show-password-btn" data-emp="${emp.id}">表示</button>
                </div>
                <div class="password-change-row">
                  <input type="text" class="password-input" data-emp="${emp.id}" placeholder="新しいパスワード">
                  <button class="change-password-btn" data-emp="${emp.id}">変更</button>
                </div>
              </div>
              
              <button class="delete-emp-btn" data-emp="${emp.id}">🗑️ この従業員を削除</button>
            </div>
          `;
        });

        // 削除済み従業員
        let deletedHtml = '';
        const deletedEmployees = App.deletedEmployees || [];
        if (deletedEmployees.length > 0) {
          deletedHtml = '<div class="deleted-section"><h3 class="form-title">🗑️ 削除済み従業員</h3>';
          deletedEmployees.forEach(emp => {
            deletedHtml += `
              <div class="master-card deleted-card">
                <div class="master-header">
                  <span class="master-name">
                    <span class="employee-id-badge">ID: ${emp.id}</span>
                    ${emp.name}
                  </span>
                  <button class="restore-btn" data-emp="${emp.id}">復旧</button>
                </div>
                <p class="master-detail">削除日: ${emp.deletedAt ? new Date(emp.deletedAt).toLocaleDateString('ja-JP') : '不明'}</p>
              </div>
            `;
          });
          deletedHtml += '</div>';
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">従業員マスタ</span>
          </div>
          <div class="list-content">
            <div class="add-form">
              <h3 class="form-title">新規従業員登録</h3>
              <input type="text" id="newEmpName" class="form-input" placeholder="従業員名">
              <select id="newEmpRole" class="form-select">
                <option value="worker">作業員（日当）</option>
                <option value="manager">責任者（日当）</option>
                <option value="parttime">アルバイト（時給）</option>
                <option value="subadmin">管理者（副）</option>
              </select>
              <div id="newEmpRateSection">
                <label id="newEmpRateLabel" class="input-label-small">日当</label>
                <input type="number" id="newEmpRate" class="form-input" placeholder="日当" value="15000">
              </div>
              <input type="text" id="newEmpPassword" class="form-input" placeholder="初期パスワード" value="1234">
              <button id="addEmployeeBtn" class="add-btn">追加</button>
            </div>
            ${employeesHtml}
            ${deletedHtml}
          </div>
        `;
      },

      siteMaster: function() {
        let sitesHtml = '';
        App.jobSites.forEach(site => {
          sitesHtml += `
            <div class="master-card">
              <div class="master-header">
                <span class="master-name">🏗️ ${site.name}</span>
              </div>
              <p class="master-detail">${site.address || '住所未設定'}</p>
              <button class="toggle-btn ${site.isActive ? 'active' : 'inactive'}" data-site="${site.id}">${site.isActive ? '有効' : '無効'}</button>
            </div>
          `;
        });

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">現場マスタ</span>
          </div>
          <div class="list-content">
            <div class="add-form">
              <h3 class="form-title">新規現場登録</h3>
              <input type="text" id="newSiteName" class="form-input" placeholder="現場名">
              <input type="text" id="newSiteAddress" class="form-input" placeholder="住所">
              <button id="addSiteBtn" class="add-btn">追加</button>
            </div>
            ${sitesHtml}
          </div>
        `;
      },

      correctionList: function() {
        const corrections = App.corrections.sort((a, b) => {
          if (a.status === 'pending' && b.status !== 'pending') return -1;
          if (a.status !== 'pending' && b.status === 'pending') return 1;
          return new Date(b.createdAt) - new Date(a.createdAt);
        });

        let correctionsHtml = '';
        if (corrections.length === 0) {
          correctionsHtml = '<p class="empty-text">修正依頼はありません</p>';
        } else {
          corrections.forEach(c => {
            const record = App.records.find(r => r.id === c.recordId);
            const statusClass = c.status === 'pending' ? 'pending' : (c.status === 'approved' ? 'approved' : 'rejected');
            const statusText = c.status === 'pending' ? '未処理' : (c.status === 'approved' ? '承認済' : '却下');
            
            correctionsHtml += `
              <div class="correction-card ${statusClass}">
                <div class="correction-header">
                  <span class="correction-employee">${c.employeeName}</span>
                  <span class="correction-status ${statusClass}">${statusText}</span>
                </div>
                <p class="correction-date">📅 ${App.formatDate(c.recordDate)}</p>
                <p class="correction-detail">
                  現場: ${record ? record.jobSiteName : '不明'}<br>
                  記録: ${record ? App.formatTime(record.clockInTime) + ' 〜 ' + App.formatTime(record.clockOutTime) : '不明'}
                </p>
                <p class="correction-reason">📝 ${c.reason}</p>
                <p class="correction-time">依頼日時: ${new Date(c.createdAt).toLocaleString('ja-JP')}</p>
                ${c.status === 'pending' ? `
                  <div class="correction-actions">
                    <button class="approve-btn" data-correction="${c.id}">承認（記録削除）</button>
                    <button class="reject-btn" data-correction="${c.id}">却下</button>
                  </div>
                ` : ''}
              </div>
            `;
          });
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">修正依頼一覧</span>
          </div>
          <div class="list-content">
            ${correctionsHtml}
          </div>
        `;
      },

      addressRequestList: function() {
        let requestsHtml = '';
        if (App.addressRequests.length === 0) {
          requestsHtml = '<p class="empty-text">住所変更届はありません</p>';
        } else {
          App.addressRequests.forEach(req => {
            requestsHtml += `
              <div class="address-request-card">
                <div class="address-request-header">
                  <span class="address-request-employee">${req.employeeName}</span>
                  <span class="address-request-date">${new Date(req.createdAt).toLocaleDateString('ja-JP')}</span>
                </div>
                <p class="address-request-detail">
                  <strong>新住所:</strong><br>
                  ${req.newAddress}
                </p>
                <div class="address-request-actions">
                  <button class="confirm-address-btn" data-request="${req.id}">✓ 確認済み（削除）</button>
                </div>
                <p class="address-request-note">※ 確認ボタンを押すとこの届出は完全に削除されます</p>
              </div>
            `;
          });
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">住所変更届一覧</span>
          </div>
          <div class="list-content">
            ${requestsHtml}
          </div>
        `;
      },

      announcement: function() {
        const currentAnnouncement = App.announcement;
        
        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">お知らせ送信</span>
          </div>
          <div class="list-content">
            <div class="announcement-section">
              <h3 class="form-title">📢 全従業員へお知らせ</h3>
              <p class="announcement-desc">入力した内容が全従業員のホーム画面に表示されます。</p>
              
              <div class="announcement-form">
                <textarea id="announcementText" class="announcement-input" placeholder="お知らせ内容を入力&#10;例：1/15（水）22:00〜24:00 システムメンテナンスのためご利用いただけません">${currentAnnouncement ? currentAnnouncement.message : ''}</textarea>
                <button id="sendAnnouncementBtn" class="announcement-btn send">📤 お知らせを送信</button>
              </div>
            </div>
            
            ${currentAnnouncement ? `
              <div class="announcement-section current">
                <h3 class="form-title">📌 現在配信中のお知らせ</h3>
                <div class="current-announcement">
                  <p class="current-announcement-text">${currentAnnouncement.message}</p>
                  <p class="current-announcement-date">送信日時: ${new Date(currentAnnouncement.createdAt).toLocaleString('ja-JP')}</p>
                </div>
                <button id="cancelAnnouncementBtn" class="announcement-btn cancel">🗑️ お知らせを取り消す</button>
              </div>
            ` : `
              <div class="announcement-section">
                <p class="no-announcement">現在配信中のお知らせはありません</p>
              </div>
            `}
          </div>
        `;
      },

      dataManagement: function() {
        // 勤怠記録の件数
        const recordCount = App.records.length;
        // 現場数
        const siteCount = App.jobSites.length;
        // 終了現場数
        const completedSiteCount = App.jobSites.filter(s => s.completedDate).length;
        // 修正依頼の件数
        const correctionCount = App.corrections.length;
        // 住所変更届の件数
        const addressRequestCount = App.addressRequests.length;
        
        // 古い勤怠記録（1年以上前）
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
        const oneYearAgoStr = oneYearAgo.toISOString().split('T')[0];
        const oldRecordCount = App.records.filter(r => r.workDate < oneYearAgoStr).length;
        
        // 6ヶ月以上前
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        const sixMonthsAgoStr = sixMonthsAgo.toISOString().split('T')[0];
        const oldRecordCount6m = App.records.filter(r => r.workDate < sixMonthsAgoStr).length;

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">データ管理</span>
          </div>
          <div class="list-content">
            <div class="cleanup-section">
              <h3 class="form-title">💾 バックアップ・復元</h3>
              <p class="backup-desc">データのバックアップを取っておくと、ブラウザのキャッシュ削除時やバージョンアップ時に復元できます。</p>
              <div class="backup-buttons">
                <button class="backup-btn export" id="exportBackup">📥 バックアップ出力</button>
                <label class="backup-btn import">
                  📤 バックアップ復元
                  <input type="file" id="importBackup" accept=".json" style="display:none;">
                </label>
              </div>
            </div>
            
            <div class="cleanup-section">
              <h3 class="form-title">📊 現在のデータ量</h3>
              <div class="cleanup-stats">
                <div class="cleanup-stat-row">
                  <span>勤怠記録</span>
                  <span>${recordCount}件</span>
                </div>
                <div class="cleanup-stat-row">
                  <span>現場</span>
                  <span>${siteCount}件（終了: ${completedSiteCount}件）</span>
                </div>
                <div class="cleanup-stat-row">
                  <span>修正依頼</span>
                  <span>${correctionCount}件</span>
                </div>
                <div class="cleanup-stat-row">
                  <span>住所変更届</span>
                  <span>${addressRequestCount}件</span>
                </div>
              </div>
            </div>
            
            <div class="cleanup-section">
              <h3 class="form-title">🏢 現場を選んで削除</h3>
              <div class="site-delete-list">
                ${App.jobSites.map(site => {
                  const recordsForSite = App.records.filter(r => r.jobSiteName === site.name).length;
                  const status = site.completedDate ? '終了' : (site.scaffoldingDone ? '架け済' : '稼働中');
                  return `
                    <div class="site-delete-item">
                      <label class="site-delete-checkbox">
                        <input type="checkbox" class="site-checkbox" data-site-id="${site.id}">
                        <span class="site-delete-name">${site.name}</span>
                      </label>
                      <span class="site-delete-info">${status}・${recordsForSite}件</span>
                    </div>
                  `;
                }).join('')}
              </div>
              <button class="cleanup-btn delete-selected-sites" id="deleteSelectedSites">選択した現場を削除</button>
            </div>
            
            <div class="cleanup-section">
              <h3 class="form-title">🗑️ 古情報削除</h3>
              
              <div class="cleanup-option">
                <div class="cleanup-option-info">
                  <span class="cleanup-option-title">6ヶ月以上前の勤怠記録</span>
                  <span class="cleanup-option-count">${oldRecordCount6m}件</span>
                </div>
                <button class="cleanup-btn" id="deleteOldRecords6m" ${oldRecordCount6m === 0 ? 'disabled' : ''}>削除</button>
              </div>
              
              <div class="cleanup-option">
                <div class="cleanup-option-info">
                  <span class="cleanup-option-title">1年以上前の勤怠記録</span>
                  <span class="cleanup-option-count">${oldRecordCount}件</span>
                </div>
                <button class="cleanup-btn" id="deleteOldRecords1y" ${oldRecordCount === 0 ? 'disabled' : ''}>削除</button>
              </div>
              
              <div class="cleanup-option">
                <div class="cleanup-option-info">
                  <span class="cleanup-option-title">終了した現場</span>
                  <span class="cleanup-option-count">${completedSiteCount}件</span>
                </div>
                <button class="cleanup-btn" id="deleteCompletedSites" ${completedSiteCount === 0 ? 'disabled' : ''}>削除</button>
              </div>
              
              <div class="cleanup-option">
                <div class="cleanup-option-info">
                  <span class="cleanup-option-title">処理済み修正依頼</span>
                  <span class="cleanup-option-count">${App.corrections.filter(c => c.status !== 'pending').length}件</span>
                </div>
                <button class="cleanup-btn" id="deleteProcessedCorrections" ${App.corrections.filter(c => c.status !== 'pending').length === 0 ? 'disabled' : ''}>削除</button>
              </div>
              
              <div class="cleanup-option">
                <div class="cleanup-option-info">
                  <span class="cleanup-option-title">住所変更届（全件）</span>
                  <span class="cleanup-option-count">${addressRequestCount}件</span>
                </div>
                <button class="cleanup-btn" id="deleteAddressRequests" ${addressRequestCount === 0 ? 'disabled' : ''}>削除</button>
              </div>
            </div>
            
            <div class="cleanup-section danger">
              <h3 class="form-title">⚠️ 全データリセット</h3>
              <p class="cleanup-warning">すべてのデータを削除し、初期状態に戻します。この操作は取り消せません。</p>
              <button class="cleanup-btn danger" id="resetAllData">全データをリセット</button>
            </div>
          </div>
        `;
      },

      csvExport: function() {
        // 月の選択肢を生成（過去12ヶ月）
        let monthOptions = '';
        const today = new Date();
        for (let i = 0; i < 12; i++) {
          const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
          const value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          const label = d.getFullYear() + '年' + (d.getMonth() + 1) + '月';
          monthOptions += `<option value="${value}">${label}</option>`;
        }

        return `
          <div class="header">
            <button id="backBtn" class="back-btn">← 戻る</button>
            <span class="header-title">CSVエクスポート</span>
          </div>
          <div class="list-content">
            <div class="export-section">
              <h3 class="form-title">📊 勤怠データをCSV出力</h3>
              <p class="export-desc">Excelやスプレッドシートで開けるCSVファイルをダウンロードできます。</p>
              
              <div class="export-form">
                <label class="edit-label">出力期間を選択</label>
                <select id="exportMonth" class="form-select">
                  ${monthOptions}
                </select>
                
                <label class="edit-label" style="margin-top: 16px;">出力形式</label>
                <div class="export-options">
                  <label class="export-option">
                    <input type="radio" name="exportType" value="daily" checked>
                    <span>日別一覧（全従業員の勤怠記録）</span>
                  </label>
                  <label class="export-option">
                    <input type="radio" name="exportType" value="summary">
                    <span>月次集計（従業員ごとの合計）</span>
                  </label>
                  <label class="export-option">
                    <input type="radio" name="exportType" value="site">
                    <span>現場別集計</span>
                  </label>
                </div>
                
                <button id="exportCsvBtn" class="export-btn">📥 CSVをダウンロード</button>
              </div>
            </div>
            
            <div class="export-preview">
              <h3 class="form-title">プレビュー</h3>
              <p class="export-desc">選択した月のデータ: <span id="previewCount">0</span>件</p>
            </div>
          </div>
        `;
      },

      // イベントバインド
      bindEvents: function(view) {
        const self = this;

        // 共通イベント
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            App.currentUser = null;
            self.render('login');
          });
        }

        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', function() {
            // siteFinanceDetailからはsiteFinanceに戻る
            if (view === 'siteFinanceDetail') {
              self.render('siteFinance');
              return;
            }
            if (App.currentUser.role === 'admin') {
              self.render('admin');
            } else if (App.currentUser.role === 'subadmin') {
              self.render('subadmin');
            } else {
              self.render('home');
            }
          });
        }

        // カレンダートグル
        if (view === 'home') {
          const toggleCalendarBtn = document.getElementById('toggleCalendarBtn');
          const calendarPopup = document.getElementById('calendarPopup');
          if (toggleCalendarBtn && calendarPopup) {
            toggleCalendarBtn.addEventListener('click', function(e) {
              e.stopPropagation();
              calendarPopup.classList.toggle('hidden');
            });
            // 画面クリックで閉じる
            document.addEventListener('click', function(e) {
              if (!calendarPopup.contains(e.target) && e.target !== toggleCalendarBtn) {
                calendarPopup.classList.add('hidden');
              }
            });
          }
        }

        // 時計更新
        if (view === 'home') {
          const clockEl = document.getElementById('clock');
          if (clockEl) {
            function updateClock() {
              clockEl.textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
            updateClock();
            setInterval(updateClock, 1000);
          }
        }

        // ログイン
        if (view === 'login') {
          const loginBtn = document.getElementById('loginBtn');
          const loginIdInput = document.getElementById('loginId');
          const loginPasswordInput = document.getElementById('loginPassword');
          const loginError = document.getElementById('loginError');

          // 半角変換関数
          function toHalfWidth(str) {
            return str.replace(/[０-９ａ-ｚＡ-Ｚ]/g, function(s) {
              return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            }).replace(/[^0-9a-zA-Z]/g, '');
          }

          // ID入力時に自動で半角変換
          if (loginIdInput) {
            loginIdInput.addEventListener('input', function() {
              const converted = toHalfWidth(this.value);
              if (this.value !== converted) {
                this.value = converted;
              }
            });
          }

          // パスワード入力時に全角を半角に変換
          if (loginPasswordInput) {
            loginPasswordInput.addEventListener('input', function() {
              const original = this.value;
              const converted = original.replace(/[０-９ａ-ｚＡ-Ｚ]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
              });
              if (original !== converted) {
                this.value = converted;
              }
            });
          }

          if (loginBtn) {
            loginBtn.addEventListener('click', function() {
              const id = toHalfWidth(loginIdInput.value.trim());
              const password = loginPasswordInput.value;
              const emp = App.employees.find(e => (e.id === id) && e.password === password && e.isActive);
              
              if (emp) {
                App.currentUser = emp;
                loginError.classList.remove('show');
                if (emp.role === 'admin') {
                  self.render('admin');
                } else if (emp.role === 'subadmin') {
                  self.render('subadmin');
                } else {
                  self.render('home');
                }
              } else {
                loginError.classList.add('show');
              }
            });
          }

          if (loginPasswordInput) {
            loginPasswordInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter') {
                loginBtn.click();
              }
            });
          }
        }

        // ホーム
        if (view === 'home') {
          const clockInBtn = document.getElementById('clockInBtn');
          const clockOutBtn = document.getElementById('clockOutBtn');
          const historyBtn = document.getElementById('historyBtn');

          if (clockInBtn) {
            clockInBtn.addEventListener('click', function() {
              if (!this.disabled) {
                App.getGPS(function() { self.render('clockIn'); });
              }
            });
          }
          if (clockOutBtn) {
            clockOutBtn.addEventListener('click', function() {
              if (!this.disabled) {
                App.getGPS(function() { self.render('clockOut'); });
              }
            });
          }
          if (historyBtn) {
            historyBtn.addEventListener('click', function() {
              self.render('history');
            });
          }

          // 設定ボタン
          const settingsBtn = document.getElementById('settingsBtn');
          if (settingsBtn) {
            settingsBtn.addEventListener('click', function() {
              self.render('settings');
            });
          }

          // 修正依頼ボタン
          document.querySelectorAll('.correction-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const recordId = this.getAttribute('data-record');
              const record = App.records.find(r => r.id === recordId);
              if (!record) return;

              const reason = prompt('修正依頼の理由を入力してください\n例: 始業時間を間違えた、終業を押し忘れた など');
              if (!reason) return;

              App.corrections.push({
                id: Date.now().toString(),
                recordId: recordId,
                recordDate: record.workDate,
                employeeId: App.currentUser.id,
                employeeName: App.currentUser.name,
                reason: reason,
                status: 'pending',
                createdAt: new Date().toISOString()
              });
              App.save();
              alert('修正依頼を送信しました。管理者が確認します。');
              self.render('home');
            });
          });
        }

        // 設定画面
        if (view === 'settings') {
          // ID変更
          const changeIdBtn = document.getElementById('changeIdBtn');
          if (changeIdBtn) {
            changeIdBtn.addEventListener('click', function() {
              const newId = document.getElementById('newIdInput').value.trim();
              if (!newId) {
                alert('新しいIDを入力してください');
                return;
              }
              if (newId === App.currentUser.id) {
                alert('現在と同じIDです');
                return;
              }
              if (App.employees.find(e => e.id === newId)) {
                alert('このIDは既に使用されています');
                return;
              }
              App.currentUser.id = newId;
              const emp = App.employees.find(e => e.id === App.currentUser.id || e.name === App.currentUser.name);
              if (emp) emp.id = newId;
              App.save();
              alert('IDを「' + newId + '」に変更しました');
              self.render('settings');
            });
          }

          // パスワード変更
          const changePasswordBtn = document.getElementById('changePasswordBtn');
          if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', function() {
              const currentPass = document.getElementById('currentPasswordInput').value;
              const newPass = document.getElementById('newPasswordInput').value;
              const confirmPass = document.getElementById('confirmPasswordInput').value;
              
              if (currentPass !== App.currentUser.password) {
                alert('現在のパスワードが正しくありません');
                return;
              }
              if (!newPass || newPass.length < 4) {
                alert('新しいパスワードは4文字以上で入力してください');
                return;
              }
              if (newPass !== confirmPass) {
                alert('新しいパスワードが一致しません');
                return;
              }
              
              App.currentUser.password = newPass;
              const emp = App.employees.find(e => e.id === App.currentUser.id);
              if (emp) emp.password = newPass;
              App.save();
              alert('パスワードを変更しました');
              self.render('settings');
            });
          }

          // 住所変更届
          const submitAddressBtn = document.getElementById('submitAddressBtn');
          if (submitAddressBtn) {
            submitAddressBtn.addEventListener('click', function() {
              const newAddress = document.getElementById('newAddressInput').value.trim();
              if (!newAddress) {
                alert('新しい住所を入力してください');
                return;
              }
              
              App.addressRequests.push({
                id: Date.now().toString(),
                employeeId: App.currentUser.id,
                employeeName: App.currentUser.name,
                newAddress: newAddress,
                createdAt: new Date().toISOString()
              });
              App.save();
              alert('住所変更届を送信しました。管理者が確認します。');
              document.getElementById('newAddressInput').value = '';
            });
          }
        }

        // 管理者/副管理者設定画面
        if (view === 'adminSettings') {
          // ID変更
          const changeIdBtn = document.getElementById('changeIdBtn');
          if (changeIdBtn) {
            changeIdBtn.addEventListener('click', function() {
              const newIdInput = document.getElementById('newIdInput');
              const newId = newIdInput ? newIdInput.value.trim() : '';
              
              if (!newId) {
                alert('新しいIDを入力してください');
                return;
              }
              if (newId === App.currentUser.id) {
                alert('現在と同じIDです');
                return;
              }
              if (App.employees.find(e => e.id === newId)) {
                alert('このIDは既に使用されています');
                return;
              }
              const oldId = App.currentUser.id;
              App.currentUser.id = newId;
              const emp = App.employees.find(e => e.id === oldId);
              if (emp) {
                emp.id = newId;
              }
              App.save();
              alert('IDを「' + newId + '」に変更しました');
              self.render('adminSettings');
            });
          }

          // パスワード変更
          const changePasswordBtn = document.getElementById('changePasswordBtn');
          if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', function() {
              const currentPass = document.getElementById('currentPasswordInput').value;
              const newPass = document.getElementById('newPasswordInput').value;
              const confirmPass = document.getElementById('confirmPasswordInput').value;
              
              if (currentPass !== App.currentUser.password) {
                alert('現在のパスワードが正しくありません');
                return;
              }
              if (!newPass || newPass.length < 4) {
                alert('新しいパスワードは4文字以上で入力してください');
                return;
              }
              if (newPass !== confirmPass) {
                alert('新しいパスワードが一致しません');
                return;
              }
              
              App.currentUser.password = newPass;
              const emp = App.employees.find(e => e.id === App.currentUser.id);
              if (emp) emp.password = newPass;
              App.save();
              alert('パスワードを変更しました');
              self.render('adminSettings');
            });
          }
        }

        // 勤怠履歴画面
        if (view === 'history') {
          const monthSelect = document.getElementById('historyMonthSelect');
          if (monthSelect) {
            monthSelect.addEventListener('change', function() {
              App.historyMonth = this.value;
              self.render('history');
            });
          }
        }

        // 始業打刻
        if (view === 'clockIn') {
          const jobSiteSelect = document.getElementById('jobSiteSelect');
          const customJobSite = document.getElementById('customJobSite');
          const confirmBtn = document.getElementById('confirmClockIn');

          // 地図を初期化
          const mapEl = document.getElementById('clockInMap');
          if (mapEl && App.gpsLocation) {
            setTimeout(function() {
              const map = L.map('clockInMap').setView([App.gpsLocation.lat, App.gpsLocation.lng], 16);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
              }).addTo(map);
              L.marker([App.gpsLocation.lat, App.gpsLocation.lng]).addTo(map)
                .bindPopup('現在地').openPopup();
            }, 100);
          }

          // 入力状態をチェックする関数
          function checkInput() {
            const hasSelect = jobSiteSelect.value !== '';
            const hasCustom = customJobSite.value.trim() !== '';
            confirmBtn.disabled = !hasSelect && !hasCustom;
          }

          if (jobSiteSelect) {
            jobSiteSelect.addEventListener('change', function() {
              // 既存現場を選んだら、新規入力欄をクリア
              if (this.value) {
                customJobSite.value = '';
              }
              checkInput();
            });
          }

          if (customJobSite) {
            customJobSite.addEventListener('input', function() {
              // 新規入力したら、選択をリセット
              if (this.value.trim()) {
                jobSiteSelect.value = '';
              }
              checkInput();
            });
          }

          if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
              let siteId = jobSiteSelect.value;
              let siteName = '';
              
              // 新規入力があればそちらを優先
              if (customJobSite.value.trim()) {
                let inputName = customJobSite.value.trim();
                
                // 類似現場名をチェック（漢字2文字以上一致）
                const similarSite = App.findSimilarSite(inputName);
                
                if (similarSite) {
                  alert("類似現場: " + similarSite);
                  if (confirm(`「${similarSite}」の現場ではありませんか？\n\n[OK] → 「${similarSite}」を使用\n[キャンセル] → 「${inputName}」で新規登録`)) {
                    siteName = similarSite;
                  } else {
                    siteName = inputName;
                  }
                } else {
                  siteName = inputName;
                }
                
                // 同じ名前の現場が既にあるかチェック
                const existingSite = App.jobSites.find(s => s.name === siteName);
                if (existingSite) {
                  siteId = existingSite.id;
                } else {
                  // 新しい現場をマスタに自動追加
                  const newSite = {
                    id: Date.now().toString(),
                    name: siteName,
                    address: '',
                    isActive: true,
                    addedBy: App.currentUser.name,
                    addedAt: new Date().toISOString()
                  };
                  App.jobSites.push(newSite);
                  siteId = newSite.id;
                }
              } else if (siteId) {
                const site = App.jobSites.find(s => s.id === siteId);
                siteName = site ? site.name : '';
              }

              if (!siteName) {
                alert('現場を選択または入力してください');
                return;
              }

              // 夜勤判定（17時〜翌5時の出勤は夜勤）
              const clockInHour = new Date().getHours();
              const shiftType = (clockInHour >= 17 || clockInHour < 5) ? 'night' : 'day';

              const newRecord = {
                id: Date.now().toString(),
                employeeId: App.currentUser.id,
                employeeName: App.currentUser.name,
                jobSiteId: siteId,
                jobSiteName: siteName,
                workDate: App.getToday(),
                clockInTime: new Date().toISOString(),
                clockOutTime: null,
                clockInLat: App.gpsLocation ? App.gpsLocation.lat : null,
                clockInLng: App.gpsLocation ? App.gpsLocation.lng : null,
                shiftType: shiftType,
                memo: '',
                status: 'working'
              };

              App.records.push(newRecord);
              App.save();
              alert('始業を記録しました！' + (shiftType === 'night' ? '（🌙夜勤）' : ''));
              self.render('home');
            });
          }
        }

        // 終業打刻
        if (view === 'clockOut') {
          const confirmBtn = document.getElementById('confirmClockOut');
          const workMemo = document.getElementById('workMemo');

          // 地図を初期化
          const mapEl = document.getElementById('clockOutMap');
          if (mapEl && App.gpsLocation) {
            setTimeout(function() {
              const map = L.map('clockOutMap').setView([App.gpsLocation.lat, App.gpsLocation.lng], 16);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
              }).addTo(map);
              L.marker([App.gpsLocation.lat, App.gpsLocation.lng]).addTo(map)
                .bindPopup('現在地').openPopup();
            }, 100);
          }

          if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
              const record = App.getTodayRecord();
              if (!record) return;

              const clockOutTime = new Date();
              const clockInTime = new Date(record.clockInTime);
              const workHours = (clockOutTime - clockInTime) / (1000 * 60 * 60);

              record.clockOutTime = clockOutTime.toISOString();
              record.clockOutLat = App.gpsLocation ? App.gpsLocation.lat : null;
              record.clockOutLng = App.gpsLocation ? App.gpsLocation.lng : null;
              record.workHours = Math.round(workHours * 100) / 100;
              record.overtimeHours = Math.max(0, Math.round((workHours - 8) * 100) / 100);
              record.memo = workMemo ? workMemo.value : '';
              record.status = 'completed';
              
              // アルバイトの場合、その時点の時給を記録に保存
              if (App.currentUser.role === 'parttime') {
                record.hourlyRate = App.currentUser.hourlyRate || 1200;
              }

              App.save();
              alert('終業を記録しました！お疲れさまでした！');
              self.render('home');
            });
          }
        }

        // 管理者画面
        if (view === 'admin') {
          document.querySelectorAll('.menu-card').forEach(function(card) {
            card.addEventListener('click', function() {
              const targetView = this.getAttribute('data-view');
              if (targetView) {
                self.render(targetView);
              }
            });
          });

          // お知らせ送信
          const sendAnnouncement = document.getElementById('sendAnnouncement');
          if (sendAnnouncement) {
            sendAnnouncement.addEventListener('click', function() {
              const input = document.getElementById('announcementInput');
              const message = input.value.trim();
              if (!message) {
                alert('メッセージを入力してください');
                return;
              }
              App.announcement = {
                message: message,
                createdAt: new Date().toISOString()
              };
              App.save();
              alert('お知らせを送信しました');
              self.render('admin');
            });
          }

          // お知らせ取り消し
          const cancelAnnouncement = document.getElementById('cancelAnnouncement');
          if (cancelAnnouncement) {
            cancelAnnouncement.addEventListener('click', function() {
              if (confirm('お知らせを取り消しますか？')) {
                App.announcement = null;
                App.save();
                self.render('admin');
              }
            });
          }

          // 管理者の出勤ボタン
          const adminClockIn = document.getElementById('adminClockIn');
          if (adminClockIn) {
            adminClockIn.addEventListener('click', function() {
              App.getGPS(function() {
                self.render('clockIn');
              });
            });
          }

          // 管理者の退勤ボタン
          const adminClockOut = document.getElementById('adminClockOut');
          if (adminClockOut) {
            adminClockOut.addEventListener('click', function() {
              App.getGPS(function() {
                self.render('clockOut');
              });
            });
          }
        }

        // 副管理者画面
        if (view === 'subadmin') {
          document.querySelectorAll('.menu-card').forEach(function(card) {
            card.addEventListener('click', function() {
              const targetView = this.getAttribute('data-view');
              if (targetView) {
                self.render(targetView);
              }
            });
          });

          // 副管理者の出勤ボタン
          const subadminClockIn = document.getElementById('subadminClockIn');
          if (subadminClockIn) {
            subadminClockIn.addEventListener('click', function() {
              App.getGPS(function() {
                self.render('clockIn');
              });
            });
          }

          // 副管理者の退勤ボタン
          const subadminClockOut = document.getElementById('subadminClockOut');
          if (subadminClockOut) {
            subadminClockOut.addEventListener('click', function() {
              App.getGPS(function() {
                self.render('clockOut');
              });
            });
          }
        }

        // 稼働現場一覧
        if (view === 'siteList') {
          const siteDateSelect = document.getElementById('siteDateSelect');
          if (siteDateSelect) {
            siteDateSelect.addEventListener('change', function() {
              App.selectedSiteDate = this.value;
              self.render('siteList');
            });
          }

          // 稼働中現場セルのクリック
          document.querySelectorAll('.site-cell:not(.completed-site)').forEach(function(cell) {
            cell.addEventListener('click', function() {
              const siteName = this.getAttribute('data-site-name');
              const siteId = this.getAttribute('data-site-id');
              const selectedDate = App.selectedSiteDate;
              const site = App.jobSites.find(s => s.id === siteId);
              
              // その日のその現場の記録を取得
              const isAdmin = App.currentUser.role === 'admin';
              let siteRecords = App.records.filter(r => 
                r.workDate === selectedDate && r.jobSiteName === siteName
              );
              if (!isAdmin) {
                siteRecords = siteRecords.filter(r => !App.PRIVATE_EMPLOYEE_IDS.includes(r.employeeId));
              }
              
              // 現場日報データを取得
              const report = App.getSiteDailyReport(selectedDate, siteName);
              
              // 従業員リストHTML
              let workersHtml = '';
              if (siteRecords.length > 0) {
                siteRecords.forEach(r => {
                  const statusClass = r.status === 'working' ? 'working' : 'completed';
                  const statusText = r.status === 'working' ? '勤務中' : '終業';
                  workersHtml += `
                    <div class="site-worker-row">
                      <span class="site-worker-name">${r.employeeName}</span>
                      <span class="site-worker-time">${App.formatTime(r.clockInTime)}〜${r.clockOutTime ? App.formatTime(r.clockOutTime) : ''}</span>
                      <span class="site-worker-status ${statusClass}">${statusText}</span>
                    </div>
                  `;
                });
              } else {
                workersHtml = '<p style="color: #64748b; font-size: 13px;">この日の出勤記録はありません</p>';
              }
              
              const detailHtml = `
                <h3 class="site-detail-title">🏗️ ${siteName}</h3>
                <p style="font-size: 12px; color: #94a3b8; margin-bottom: 16px;">${App.formatDate(selectedDate)}</p>
                
                <div class="site-detail-section">
                  <h4 class="site-detail-section-title">👷 自社作業員（${siteRecords.length}名）</h4>
                  ${workersHtml}
                </div>
                
                <div class="site-detail-section">
                  <h4 class="site-detail-section-title">📝 現場日報</h4>
                  <div class="site-report-input-group">
                    <label class="site-report-label">業者作業員人数</label>
                    <input type="number" id="vendorWorkersInput" class="site-report-input" value="${report.vendorWorkers}" min="0">
                  </div>
                  <div class="site-report-input-group">
                    <label class="site-report-label">請負金額（円）</label>
                    <input type="number" id="contractAmountInput" class="site-report-input" value="${report.contractAmount}" min="0">
                  </div>
                  <div class="site-report-input-group">
                    <label class="site-report-label">トラック台数</label>
                    <input type="number" id="truckCountInput" class="site-report-input" value="${report.truckCount}" min="0">
                  </div>
                  <div class="site-report-input-group">
                    <label class="site-report-label">協力会社発注金額（円）</label>
                    <input type="number" id="subcontractAmountInput" class="site-report-input" value="${report.subcontractAmount}" min="0">
                  </div>
                  <button class="site-report-save-btn" id="saveSiteReportBtn" 
                    data-date="${selectedDate}" data-site="${siteName}">
                    💾 保存
                  </button>
                </div>
                
                <div class="site-completion-section">
                  <h4 class="site-completion-title">🏁 完工処理</h4>
                  <button class="site-completion-btn scaffolding ${site && site.scaffoldingDone ? 'done' : ''}" 
                    id="scaffoldingBtn" data-site-id="${siteId}">
                    ${site && site.scaffoldingDone ? '✓ 足場架け完了済み' : '足場架け完了'}
                  </button>
                  <button class="site-completion-btn complete" id="completeBtn" data-site-id="${siteId}">
                    足場払し完了（完工）
                  </button>
                </div>
              `;
              
              document.getElementById('siteDetailBody').innerHTML = detailHtml;
              document.getElementById('siteDetailModal').classList.remove('hidden');
              
              // 保存ボタン
              const saveBtn = document.getElementById('saveSiteReportBtn');
              if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                  const date = this.getAttribute('data-date');
                  const site = this.getAttribute('data-site');
                  const data = {
                    vendorWorkers: parseInt(document.getElementById('vendorWorkersInput').value) || 0,
                    contractAmount: parseInt(document.getElementById('contractAmountInput').value) || 0,
                    truckCount: parseInt(document.getElementById('truckCountInput').value) || 0,
                    subcontractAmount: parseInt(document.getElementById('subcontractAmountInput').value) || 0
                  };
                  App.saveSiteDailyReport(date, site, data);
                  alert('現場日報を保存しました');
                });
              }
              
              // 足場架け完了ボタン
              const scaffoldingBtn = document.getElementById('scaffoldingBtn');
              if (scaffoldingBtn) {
                scaffoldingBtn.addEventListener('click', function() {
                  const siteId = this.getAttribute('data-site-id');
                  const site = App.jobSites.find(s => s.id === siteId);
                  if (site) {
                    if (site.scaffoldingDone) {
                      if (confirm('足場架け完了を取り消しますか？')) {
                        site.scaffoldingDone = false;
                        site.scaffoldingDate = null;
                        App.save();
                        document.getElementById('siteDetailModal').classList.add('hidden');
                        self.render('siteList');
                      }
                    } else {
                      if (confirm('足場架け完了にしますか？')) {
                        site.scaffoldingDone = true;
                        site.scaffoldingDate = App.getToday();
                        App.save();
                        document.getElementById('siteDetailModal').classList.add('hidden');
                        self.render('siteList');
                      }
                    }
                  }
                });
              }
              
              // 完工ボタン
              const completeBtn = document.getElementById('completeBtn');
              if (completeBtn) {
                completeBtn.addEventListener('click', function() {
                  const siteId = this.getAttribute('data-site-id');
                  const site = App.jobSites.find(s => s.id === siteId);
                  if (site) {
                    if (confirm('「' + site.name + '」を完工（足場払し完了）にしますか？\n\n完工した現場は終了現場一覧に移動します。')) {
                      site.completedDate = App.getToday();
                      App.save();
                      document.getElementById('siteDetailModal').classList.add('hidden');
                      alert('完工しました');
                      self.render('siteList');
                    }
                  }
                });
              }
            });
          });
          
          // 終了現場セルのクリック（稼働に戻す）
          document.querySelectorAll('.site-cell.completed-site').forEach(function(cell) {
            cell.addEventListener('click', function() {
              const siteId = this.getAttribute('data-site-id');
              const siteName = this.getAttribute('data-site-name');
              const site = App.jobSites.find(s => s.id === siteId);
              
              if (site) {
                const detailHtml = `
                  <h3 class="site-detail-title">✅ ${siteName}</h3>
                  <p style="font-size: 12px; color: #94a3b8; margin-bottom: 16px;">完工日: ${site.completedDate}</p>
                  
                  <div class="site-detail-section">
                    <p style="color: #f1f5f9; font-size: 14px; margin-bottom: 16px;">この現場は完工済みです。</p>
                    <button class="site-completion-btn restore" id="restoreSiteBtn" data-site-id="${siteId}">
                      🔄 稼働現場に戻す
                    </button>
                  </div>
                `;
                
                document.getElementById('siteDetailBody').innerHTML = detailHtml;
                document.getElementById('siteDetailModal').classList.remove('hidden');
                
                // 稼働に戻すボタン
                const restoreBtn = document.getElementById('restoreSiteBtn');
                if (restoreBtn) {
                  restoreBtn.addEventListener('click', function() {
                    const siteId = this.getAttribute('data-site-id');
                    const site = App.jobSites.find(s => s.id === siteId);
                    if (site) {
                      if (confirm('「' + site.name + '」を稼働現場に戻しますか？')) {
                        site.completedDate = null;
                        App.save();
                        document.getElementById('siteDetailModal').classList.add('hidden');
                        alert('稼働現場に戻しました');
                        self.render('siteList');
                      }
                    }
                  });
                }
              }
            });
          });

          // 詳細モーダルを閉じる
          const closeBtn = document.getElementById('closeSiteDetailModal');
          if (closeBtn) {
            closeBtn.addEventListener('click', function() {
              document.getElementById('siteDetailModal').classList.add('hidden');
            });
          }
        }

        // 各現場収支
        if (view === 'siteFinance') {
          document.querySelectorAll('.finance-card-link').forEach(function(card) {
            card.addEventListener('click', function() {
              const siteId = this.getAttribute('data-site-id');
              App.selectedSiteId = siteId;
              self.render('siteFinanceDetail');
            });
          });
        }
        
        // 各現場収支詳細
        if (view === 'siteFinanceDetail') {
          // アコーディオン開閉
          document.querySelectorAll('.accordion-header').forEach(function(header) {
            header.addEventListener('click', function() {
              const section = this.getAttribute('data-section');
              const item = this.closest('.accordion-item');
              if (item.classList.contains('disabled')) return;
              
              const body = document.getElementById('accordion' + section.charAt(0).toUpperCase() + section.slice(1));
              const isHidden = body.classList.contains('hidden');
              
              // 全部閉じる
              document.querySelectorAll('.accordion-body').forEach(b => b.classList.add('hidden'));
              document.querySelectorAll('.accordion-header span').forEach(s => {
                s.textContent = s.textContent.replace('▼', '▶');
              });
              
              // クリックしたものを開く
              if (isHidden) {
                body.classList.remove('hidden');
                this.querySelector('span').textContent = this.querySelector('span').textContent.replace('▶', '▼');
              }
            });
          });
          
          // 総計保存ボタン
          const saveTotalBtn = document.getElementById('saveTotalBtn');
          if (saveTotalBtn) {
            saveTotalBtn.addEventListener('click', function() {
              const existingData = App.getSiteFinance(App.selectedSiteId, 'total', 'all');
              const data = {
                contractAmount: parseInt(document.getElementById('totalContract').value) || 0,
                laborCost: parseInt(document.getElementById('additionalLabor').value) || 0,
                subcontractAmount: parseInt(document.getElementById('additionalSubcontract').value) || 0,
                truckCount: parseInt(document.getElementById('additionalTruck').value) || 0,
                materialMonths: existingData.materialMonths || []
              };
              App.saveSiteFinance(App.selectedSiteId, 'total', 'all', data);
              alert('保存しました');
              self.render('siteFinanceDetail');
            });
          }
          
          // 材料費追加ボタン
          const addMaterialBtn = document.getElementById('addMaterialMonth');
          if (addMaterialBtn) {
            addMaterialBtn.addEventListener('click', function() {
              document.getElementById('materialMonth').value = '';
              document.getElementById('materialBasic').value = '0';
              document.getElementById('materialRental').value = '0';
              document.getElementById('materialModal').classList.remove('hidden');
            });
          }
          
          // 材料費モーダル閉じる
          const closeMaterialModal = document.getElementById('closeMaterialModal');
          if (closeMaterialModal) {
            closeMaterialModal.addEventListener('click', function() {
              document.getElementById('materialModal').classList.add('hidden');
            });
          }
          
          // 材料費保存
          const saveMaterialMonth = document.getElementById('saveMaterialMonth');
          if (saveMaterialMonth) {
            saveMaterialMonth.addEventListener('click', function() {
              const month = document.getElementById('materialMonth').value;
              if (!month) {
                alert('月を入力してください');
                return;
              }
              const basicCost = parseInt(document.getElementById('materialBasic').value) || 0;
              const rentalCost = parseInt(document.getElementById('materialRental').value) || 0;
              
              const existingData = App.getSiteFinance(App.selectedSiteId, 'total', 'all');
              const materialMonths = existingData.materialMonths || [];
              materialMonths.push({ month, basicCost, rentalCost });
              
              existingData.materialMonths = materialMonths;
              App.saveSiteFinance(App.selectedSiteId, 'total', 'all', existingData);
              document.getElementById('materialModal').classList.add('hidden');
              self.render('siteFinanceDetail');
            });
          }
          
          // 材料費削除
          document.querySelectorAll('.material-del-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const idx = parseInt(this.getAttribute('data-idx'));
              if (confirm('この月の材料費を削除しますか？')) {
                const existingData = App.getSiteFinance(App.selectedSiteId, 'total', 'all');
                const materialMonths = existingData.materialMonths || [];
                materialMonths.splice(idx, 1);
                existingData.materialMonths = materialMonths;
                App.saveSiteFinance(App.selectedSiteId, 'total', 'all', existingData);
                self.render('siteFinanceDetail');
              }
            });
          });
          
          // 足場架け保存ボタン
          const saveScaffoldingBtn = document.getElementById('saveScaffoldingBtn');
          if (saveScaffoldingBtn) {
            saveScaffoldingBtn.addEventListener('click', function() {
              const data = {
                contractAmount: parseInt(document.getElementById('scaffoldingContract').value) || 0,
                laborCost: parseInt(document.getElementById('scaffoldingLabor').value) || 0
              };
              App.saveSiteFinance(App.selectedSiteId, 'scaffolding', 'all', data);
              alert('保存しました');
              self.render('siteFinanceDetail');
            });
          }
          
          // 完工保存ボタン
          const saveCompletionBtn = document.getElementById('saveCompletionBtn');
          if (saveCompletionBtn) {
            saveCompletionBtn.addEventListener('click', function() {
              const data = {
                contractAmount: parseInt(document.getElementById('completionContract').value) || 0,
                laborCost: parseInt(document.getElementById('completionLabor').value) || 0
              };
              App.saveSiteFinance(App.selectedSiteId, 'completion', 'all', data);
              alert('保存しました');
              self.render('siteFinanceDetail');
            });
          }
        }

        // 終了現場
        if (view === 'completedSiteList') {
          // 終了現場セルのクリック
          document.querySelectorAll('.site-cell.completed-site').forEach(function(cell) {
            cell.addEventListener('click', function() {
              const siteId = this.getAttribute('data-site-id');
              const siteName = this.getAttribute('data-site-name');
              const site = App.jobSites.find(s => s.id === siteId);
              
              if (site) {
                const detailHtml = `
                  <h3 class="site-detail-title">✅ ${siteName}</h3>
                  <p style="font-size: 12px; color: #94a3b8; margin-bottom: 16px;">完工日: ${site.completedDate}</p>
                  
                  <div class="site-detail-section">
                    <p style="color: #f1f5f9; font-size: 14px; margin-bottom: 16px;">この現場は完工済みです。</p>
                    <button class="site-completion-btn restore" id="restoreSiteBtn" data-site-id="${siteId}">
                      🔄 稼働現場に戻す
                    </button>
                  </div>
                `;
                
                document.getElementById('siteDetailBody').innerHTML = detailHtml;
                document.getElementById('siteDetailModal').classList.remove('hidden');
                
                // 稼働に戻すボタン
                const restoreBtn = document.getElementById('restoreSiteBtn');
                if (restoreBtn) {
                  restoreBtn.addEventListener('click', function() {
                    const siteId = this.getAttribute('data-site-id');
                    const site = App.jobSites.find(s => s.id === siteId);
                    if (site) {
                      if (confirm('「' + site.name + '」を稼働現場に戻しますか？')) {
                        site.completedDate = null;
                        App.save();
                        document.getElementById('siteDetailModal').classList.add('hidden');
                        alert('稼働現場に戻しました');
                        self.render('completedSiteList');
                      }
                    }
                  });
                }
              }
            });
          });

          // 詳細モーダルを閉じる
          const closeBtn = document.getElementById('closeSiteDetailModal');
          if (closeBtn) {
            closeBtn.addEventListener('click', function() {
              document.getElementById('siteDetailModal').classList.add('hidden');
            });
          }
        }

        // 出勤一覧
        if (view === 'dailyList') {
          const dateSelect = document.getElementById('dateSelect');
          if (dateSelect) {
            dateSelect.addEventListener('change', function() {
              App.selectedDate = this.value;
              self.render('dailyList');
            });
          }

          // マーク（◯）のクリックで詳細表示
          let modalMap = null;
          document.querySelectorAll('.attendance-mark-item').forEach(function(markItem) {
            markItem.addEventListener('click', function(e) {
              e.stopPropagation();
              const recordId = this.getAttribute('data-record-id');
              const record = App.records.find(r => r.id === recordId);
              if (!record) return;

              const hasGps = record.clockInLat && record.clockInLng;
              const shiftLabel = record.shiftType === 'night' ? '🌙 夜勤' : '☀️ 日勤';
              const statusLabel = record.status === 'completed' ? '終業' : '勤務中';
              
              const detailHtml = `
                <h3 class="attendance-detail-name">${record.employeeName}</h3>
                <div class="attendance-detail-row">
                  <span class="attendance-detail-label">状態</span>
                  <span class="attendance-detail-value" style="color: ${record.status === 'completed' ? '#f59e0b' : '#10b981'}">${statusLabel}</span>
                </div>
                <div class="attendance-detail-row">
                  <span class="attendance-detail-label">現場</span>
                  <span class="attendance-detail-value">${record.jobSiteName}</span>
                </div>
                <div class="attendance-detail-row">
                  <span class="attendance-detail-label">区分</span>
                  <span class="attendance-detail-value">${shiftLabel}</span>
                </div>
                <div class="attendance-detail-row">
                  <span class="attendance-detail-label">始業</span>
                  <span class="attendance-detail-value">${App.formatTime(record.clockInTime)}</span>
                </div>
                <div class="attendance-detail-row">
                  <span class="attendance-detail-label">終業</span>
                  <span class="attendance-detail-value">${record.clockOutTime ? App.formatTime(record.clockOutTime) : '−'}</span>
                </div>
                ${record.workHours ? `
                <div class="attendance-detail-row">
                  <span class="attendance-detail-label">勤務時間</span>
                  <span class="attendance-detail-value">${record.workHours.toFixed(1)}時間</span>
                </div>
                ` : ''}
                <button class="attendance-detail-map-btn" id="showMapFromDetail" 
                  data-lat="${record.clockInLat || ''}" 
                  data-lng="${record.clockInLng || ''}"
                  data-name="${record.employeeName}"
                  data-site="${record.jobSiteName}"
                  data-time="${App.formatTime(record.clockInTime)}"
                  ${!hasGps ? 'disabled' : ''}>
                  📍 ${hasGps ? '打刻場所を地図で見る' : '位置情報なし'}
                </button>
                ${(App.currentUser.role === 'admin' || App.currentUser.role === 'subadmin') ? `
                <button class="attendance-detail-delete-btn" id="deleteRecordBtn" data-record-id="${record.id}">
                  🗑️ この記録を削除
                </button>
                ` : ''}
              `;
              
              document.getElementById('attendanceDetailBody').innerHTML = detailHtml;
              document.getElementById('attendanceDetailModal').classList.remove('hidden');

              // 削除ボタン
              const deleteBtn = document.getElementById('deleteRecordBtn');
              if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                  const recId = this.getAttribute('data-record-id');
                  const rec = App.records.find(r => r.id === recId);
                  if (!rec) return;
                  
                  if (!confirm('この記録を削除しますか？\n\n' + rec.employeeName + '\n' + App.formatDate(rec.workDate) + ' ' + App.formatTime(rec.clockInTime) + '〜\n現場: ' + rec.jobSiteName + '\n\nこの操作は取り消せません。')) {
                    return;
                  }
                  
                  App.records = App.records.filter(r => r.id !== recId);
                  App.save();
                  document.getElementById('attendanceDetailModal').classList.add('hidden');
                  alert('記録を削除しました');
                  self.render('dailyList');
                });
              }

              // 地図ボタン
              const mapBtn = document.getElementById('showMapFromDetail');
              if (mapBtn && hasGps) {
                mapBtn.addEventListener('click', function() {
                  const lat = parseFloat(this.getAttribute('data-lat'));
                  const lng = parseFloat(this.getAttribute('data-lng'));
                  const name = this.getAttribute('data-name');
                  const site = this.getAttribute('data-site');
                  const time = this.getAttribute('data-time');

                  document.getElementById('attendanceDetailModal').classList.add('hidden');
                  
                  const modal = document.getElementById('mapModal');
                  const title = document.getElementById('mapModalTitle');
                  const info = document.getElementById('mapModalInfo');

                  title.textContent = name + ' の打刻場所';
                  info.textContent = '現場: ' + site + ' ／ 始業: ' + time;
                  modal.classList.remove('hidden');

                  setTimeout(function() {
                    if (modalMap) {
                      modalMap.remove();
                    }
                    modalMap = L.map('modalMap').setView([lat, lng], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                      attribution: '© OpenStreetMap'
                    }).addTo(modalMap);
                    L.marker([lat, lng]).addTo(modalMap)
                      .bindPopup(name + '<br>' + site).openPopup();
                  }, 100);
                });
              }
            });
          });

          // 詳細モーダルを閉じる
          const closeDetailBtn = document.getElementById('closeDetailModal');
          if (closeDetailBtn) {
            closeDetailBtn.addEventListener('click', function() {
              document.getElementById('attendanceDetailModal').classList.add('hidden');
            });
          }

          // 地図モーダルを閉じる
          const closeBtn = document.getElementById('closeMapModal');
          if (closeBtn) {
            closeBtn.addEventListener('click', function() {
              document.getElementById('mapModal').classList.add('hidden');
              if (modalMap) {
                modalMap.remove();
                modalMap = null;
              }
            });
          }
        }

        // 従業員マスタ
        if (view === 'employeeMaster') {
          const addBtn = document.getElementById('addEmployeeBtn');
          if (addBtn) {
            addBtn.addEventListener('click', function() {
              const name = document.getElementById('newEmpName').value.trim();
              const role = document.getElementById('newEmpRole').value;
              const rate = parseInt(document.getElementById('newEmpRate').value) || (role === 'parttime' ? 1200 : 15000);
              const password = document.getElementById('newEmpPassword').value || '1234';

              if (!name) {
                alert('従業員名を入力してください');
                return;
              }

              const maxId = Math.max(...App.employees.filter(e => e.id !== 'admin').map(e => parseInt(e.id)));
              const newId = (maxId + 1).toString();

              const newEmp = {
                id: newId,
                name: name,
                role: role,
                dailyRate: role === 'parttime' ? 0 : rate,
                hourlyRate: role === 'parttime' ? rate : 0,
                isActive: true,
                password: password
              };
              App.employees.push(newEmp);
              App.save();
              self.render('employeeMaster');
            });
          }

          // 新規登録フォームの役割変更時にラベル切り替え
          const newEmpRole = document.getElementById('newEmpRole');
          if (newEmpRole) {
            newEmpRole.addEventListener('change', function() {
              const label = document.getElementById('newEmpRateLabel');
              const input = document.getElementById('newEmpRate');
              if (this.value === 'parttime') {
                label.textContent = '時給';
                input.placeholder = '時給';
                input.value = '1200';
              } else {
                label.textContent = '日当';
                input.placeholder = '日当';
                input.value = '15000';
              }
            });
          }

          // 名前変更
          document.querySelectorAll('.save-name-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const inputEl = document.querySelector('.name-input[data-emp="' + empId + '"]');
              const newName = inputEl.value.trim();
              if (!newName) {
                alert('名前を入力してください');
                return;
              }
              const emp = App.employees.find(e => e.id === empId);
              emp.name = newName;
              App.save();
              alert('名前を「' + newName + '」に変更しました');
              self.render('employeeMaster');
            });
          });

          // 日当/時給変更
          document.querySelectorAll('.save-rate-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const inputEl = document.querySelector('.rate-input[data-emp="' + empId + '"]');
              const newRate = parseInt(inputEl.value);
              if (!newRate || newRate < 0) {
                alert('正しい金額を入力してください');
                return;
              }
              const emp = App.employees.find(e => e.id === empId);
              if (emp.role === 'parttime') {
                emp.hourlyRate = newRate;
                App.save();
                alert('時給を ¥' + newRate.toLocaleString() + ' に変更しました');
              } else {
                emp.dailyRate = newRate;
                App.save();
                alert('日当を ¥' + newRate.toLocaleString() + ' に変更しました');
              }
            });
          });

          // 有給付与日変更
          document.querySelectorAll('.save-paid-leave-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const inputEl = document.querySelector('.paid-leave-input[data-emp="' + empId + '"]');
              const newDate = inputEl.value;
              const emp = App.employees.find(e => e.id === empId);
              emp.paidLeaveDate = newDate;
              App.save();
              if (newDate) {
                const d = new Date(newDate);
                alert('有給付与日を ' + d.getFullYear() + '年' + (d.getMonth() + 1) + '月' + d.getDate() + '日 に設定しました');
              } else {
                alert('有給付与日をクリアしました');
              }
              self.render('employeeMaster');
            });
          });

          // 役割変更
          document.querySelectorAll('.save-role-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const selectEl = document.querySelector('.role-select[data-emp="' + empId + '"]');
              const newRole = selectEl.value;
              const emp = App.employees.find(e => e.id === empId);
              const oldRole = emp.role;
              emp.role = newRole;
              
              // 役割が変わったら金額をリセット
              if (newRole === 'parttime' && oldRole !== 'parttime') {
                emp.hourlyRate = 1200;
                emp.dailyRate = 0;
              } else if (newRole !== 'parttime' && oldRole === 'parttime') {
                emp.dailyRate = 15000;
                emp.hourlyRate = 0;
              }
              
              App.save();
              const roleText = newRole === 'manager' ? '責任者' : (newRole === 'parttime' ? 'アルバイト' : (newRole === 'subadmin' ? '管理者（副）' : '作業員'));
              alert('役割を「' + roleText + '」に変更しました');
              self.render('employeeMaster');
            });
          });

          // パスワード表示
          document.querySelectorAll('.show-password-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const emp = App.employees.find(e => e.id === empId);
              const valueEl = document.querySelector('.password-value[data-emp="' + empId + '"]');
              if (valueEl.textContent === '••••') {
                valueEl.textContent = emp.password;
                this.textContent = '隠す';
              } else {
                valueEl.textContent = '••••';
                this.textContent = '表示';
              }
            });
          });

          // パスワード変更
          document.querySelectorAll('.change-password-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const inputEl = document.querySelector('.password-input[data-emp="' + empId + '"]');
              const newPass = inputEl.value.trim();
              if (!newPass || newPass.length < 4) {
                alert('パスワードは4文字以上で入力してください');
                return;
              }
              const emp = App.employees.find(e => e.id === empId);
              emp.password = newPass;
              App.save();
              alert('パスワードを更新しました');
              inputEl.value = '';
            });
          });

          // 有効/無効切替
          document.querySelectorAll('.toggle-btn[data-emp]').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const emp = App.employees.find(e => e.id === empId);
              emp.isActive = !emp.isActive;
              App.save();
              self.render('employeeMaster');
            });
          });

          // ID変更
          document.querySelectorAll('.save-id-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const oldId = this.getAttribute('data-emp');
              const inputEl = document.querySelector('.id-input[data-emp="' + oldId + '"]');
              const newId = inputEl.value.trim();
              
              if (!newId) {
                alert('IDを入力してください');
                return;
              }
              if (newId === oldId) {
                return;
              }
              // 重複チェック
              if (App.employees.find(e => e.id === newId)) {
                alert('このIDは既に使用されています');
                return;
              }
              
              const emp = App.employees.find(e => e.id === oldId);
              emp.id = newId;
              App.save();
              alert('IDを「' + newId + '」に変更しました');
              self.render('employeeMaster');
            });
          });

          // 従業員削除
          document.querySelectorAll('.delete-emp-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const emp = App.employees.find(e => e.id === empId);
              
              if (!confirm('「' + emp.name + '」を削除しますか？\n\n※ 削除済み一覧から復旧できます')) {
                return;
              }
              
              // 削除済みリストに移動
              emp.deletedAt = new Date().toISOString();
              App.deletedEmployees.push(emp);
              App.employees = App.employees.filter(e => e.id !== empId);
              App.save();
              alert('削除しました');
              self.render('employeeMaster');
            });
          });

          // 従業員復旧
          document.querySelectorAll('.restore-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const empId = this.getAttribute('data-emp');
              const emp = App.deletedEmployees.find(e => e.id === empId);
              
              if (!confirm('「' + emp.name + '」を復旧しますか？')) {
                return;
              }
              
              // 従業員リストに戻す
              delete emp.deletedAt;
              App.employees.push(emp);
              App.deletedEmployees = App.deletedEmployees.filter(e => e.id !== empId);
              App.save();
              alert('復旧しました');
              self.render('employeeMaster');
            });
          });
        }

        // 現場マスタ
        if (view === 'siteMaster') {
          const addBtn = document.getElementById('addSiteBtn');
          if (addBtn) {
            addBtn.addEventListener('click', function() {
              const name = document.getElementById('newSiteName').value.trim();
              const address = document.getElementById('newSiteAddress').value.trim();

              if (!name) {
                alert('現場名を入力してください');
                return;
              }

              App.jobSites.push({
                id: Date.now().toString(),
                name: name,
                address: address,
                isActive: true
              });
              App.save();
              self.render('siteMaster');
            });
          }

          document.querySelectorAll('.toggle-btn[data-site]').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const siteId = this.getAttribute('data-site');
              const site = App.jobSites.find(s => s.id === siteId);
              site.isActive = !site.isActive;
              App.save();
              self.render('siteMaster');
            });
          });
        }

        // 修正依頼一覧
        if (view === 'correctionList') {
          // 承認ボタン
          document.querySelectorAll('.approve-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const correctionId = this.getAttribute('data-correction');
              const correction = App.corrections.find(c => c.id === correctionId);
              if (!correction) return;

              if (!confirm('この修正依頼を承認し、該当の勤怠記録を削除しますか？')) return;

              // 勤怠記録を削除
              App.records = App.records.filter(r => r.id !== correction.recordId);
              
              // 修正依頼を承認済みに
              correction.status = 'approved';
              correction.processedAt = new Date().toISOString();
              
              App.save();
              alert('承認しました。勤怠記録を削除しました。');
              self.render('correctionList');
            });
          });

          // 却下ボタン
          document.querySelectorAll('.reject-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const correctionId = this.getAttribute('data-correction');
              const correction = App.corrections.find(c => c.id === correctionId);
              if (!correction) return;

              if (!confirm('この修正依頼を却下しますか？')) return;

              correction.status = 'rejected';
              correction.processedAt = new Date().toISOString();
              
              App.save();
              alert('却下しました。');
              self.render('correctionList');
            });
          });
        }

        // 住所変更依頼一覧
        if (view === 'addressRequestList') {
          document.querySelectorAll('.confirm-address-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              const requestId = this.getAttribute('data-request');
              
              if (!confirm('この住所変更届を確認済みとして削除しますか？\n（削除後は復元できません）')) return;

              // 完全に削除
              App.addressRequests = App.addressRequests.filter(r => r.id !== requestId);
              App.save();
              alert('確認済みとして削除しました。');
              self.render('addressRequestList');
            });
          });
        }

        // お知らせ送信
        if (view === 'announcement') {
          const announcementText = document.getElementById('announcementText');
          const sendBtn = document.getElementById('sendAnnouncementBtn');
          const cancelBtn = document.getElementById('cancelAnnouncementBtn');
          
          if (sendBtn) {
            sendBtn.addEventListener('click', function() {
              const message = announcementText.value.trim();
              if (!message) {
                alert('お知らせ内容を入力してください');
                return;
              }
              
              if (confirm('このお知らせを全従業員に送信しますか？\n\n' + message)) {
                App.announcement = {
                  message: message,
                  createdAt: new Date().toISOString()
                };
                App.save();
                alert('お知らせを送信しました');
                self.render('announcement');
              }
            });
          }
          
          if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
              if (confirm('お知らせを取り消しますか？\n全従業員の画面から非表示になります。')) {
                App.announcement = null;
                App.save();
                alert('お知らせを取り消しました');
                self.render('announcement');
              }
            });
          }
        }

        // データ管理
        if (view === 'dataManagement') {
          // バックアップ出力
          const exportBackup = document.getElementById('exportBackup');
          if (exportBackup) {
            exportBackup.addEventListener('click', function() {
              const backupData = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                data: {
                  employees: App.employees,
                  jobSites: App.jobSites,
                  records: App.records,
                  corrections: App.corrections,
                  addressRequests: App.addressRequests,
                  siteDailyReports: App.siteDailyReports,
                  siteFinanceData: App.siteFinanceData,
                  deletedEmployees: App.deletedEmployees
                }
              };
              
              const json = JSON.stringify(backupData, null, 2);
              const blob = new Blob([json], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              
              const today = new Date().toISOString().split('T')[0];
              const a = document.createElement('a');
              a.href = url;
              a.download = 'kintai_backup_' + today + '.json';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              
              alert('バックアップファイルをダウンロードしました');
            });
          }
          
          // バックアップ復元
          const importBackup = document.getElementById('importBackup');
          if (importBackup) {
            importBackup.addEventListener('change', function(e) {
              const file = e.target.files[0];
              if (!file) return;
              
              const reader = new FileReader();
              reader.onload = function(event) {
                try {
                  const backupData = JSON.parse(event.target.result);
                  
                  if (!backupData.data) {
                    alert('無効なバックアップファイルです');
                    return;
                  }
                  
                  const exportDate = backupData.exportDate ? new Date(backupData.exportDate).toLocaleString('ja-JP') : '不明';
                  
                  if (confirm('バックアップを復元しますか？\n\n出力日時: ' + exportDate + '\n\n現在のデータは上書きされます。')) {
                    if (backupData.data.employees) App.employees = backupData.data.employees;
                    if (backupData.data.jobSites) App.jobSites = backupData.data.jobSites;
                    if (backupData.data.records) App.records = backupData.data.records;
                    if (backupData.data.corrections) App.corrections = backupData.data.corrections;
                    if (backupData.data.addressRequests) App.addressRequests = backupData.data.addressRequests;
                    if (backupData.data.siteDailyReports) App.siteDailyReports = backupData.data.siteDailyReports;
                    if (backupData.data.siteFinanceData) App.siteFinanceData = backupData.data.siteFinanceData;
                    if (backupData.data.deletedEmployees) App.deletedEmployees = backupData.data.deletedEmployees;
                    
                    App.save();
                    alert('バックアップを復元しました');
                    self.render('dataManagement');
                  }
                } catch (err) {
                  alert('ファイルの読み込みに失敗しました');
                }
              };
              reader.readAsText(file);
            });
          }
          
          // 6ヶ月以上前の勤怠記録削除
          const deleteOldRecords6m = document.getElementById('deleteOldRecords6m');
          if (deleteOldRecords6m) {
            deleteOldRecords6m.addEventListener('click', function() {
              const sixMonthsAgo = new Date();
              sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
              const sixMonthsAgoStr = sixMonthsAgo.toISOString().split('T')[0];
              const count = App.records.filter(r => r.workDate < sixMonthsAgoStr).length;
              
              if (confirm(`6ヶ月以上前の勤怠記録 ${count}件 を削除しますか？\nこの操作は取り消せません。`)) {
                App.records = App.records.filter(r => r.workDate >= sixMonthsAgoStr);
                App.save();
                alert(`${count}件の勤怠記録を削除しました`);
                self.render('dataManagement');
              }
            });
          }
          
          // 1年以上前の勤怠記録削除
          const deleteOldRecords1y = document.getElementById('deleteOldRecords1y');
          if (deleteOldRecords1y) {
            deleteOldRecords1y.addEventListener('click', function() {
              const oneYearAgo = new Date();
              oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
              const oneYearAgoStr = oneYearAgo.toISOString().split('T')[0];
              const count = App.records.filter(r => r.workDate < oneYearAgoStr).length;
              
              if (confirm(`1年以上前の勤怠記録 ${count}件 を削除しますか？\nこの操作は取り消せません。`)) {
                App.records = App.records.filter(r => r.workDate >= oneYearAgoStr);
                App.save();
                alert(`${count}件の勤怠記録を削除しました`);
                self.render('dataManagement');
              }
            });
          }
          
          // 終了した現場削除
          const deleteCompletedSites = document.getElementById('deleteCompletedSites');
          if (deleteCompletedSites) {
            deleteCompletedSites.addEventListener('click', function() {
              const completedSites = App.jobSites.filter(s => s.completedDate);
              const count = completedSites.length;
              
              if (confirm(`終了した現場 ${count}件 を削除しますか？\n関連する収支データも削除されます。\nこの操作は取り消せません。`)) {
                const completedIds = completedSites.map(s => s.id);
                App.jobSites = App.jobSites.filter(s => !s.completedDate);
                // 関連する収支データも削除
                completedIds.forEach(id => {
                  Object.keys(App.siteFinanceData).forEach(key => {
                    if (key.startsWith(id + '_')) {
                      delete App.siteFinanceData[key];
                    }
                  });
                });
                App.save();
                alert(`${count}件の終了現場を削除しました`);
                self.render('dataManagement');
              }
            });
          }
          
          // 処理済み修正依頼削除
          const deleteProcessedCorrections = document.getElementById('deleteProcessedCorrections');
          if (deleteProcessedCorrections) {
            deleteProcessedCorrections.addEventListener('click', function() {
              const count = App.corrections.filter(c => c.status !== 'pending').length;
              
              if (confirm(`処理済みの修正依頼 ${count}件 を削除しますか？`)) {
                App.corrections = App.corrections.filter(c => c.status === 'pending');
                App.save();
                alert(`${count}件の修正依頼を削除しました`);
                self.render('dataManagement');
              }
            });
          }
          
          // 住所変更届削除
          const deleteAddressRequests = document.getElementById('deleteAddressRequests');
          if (deleteAddressRequests) {
            deleteAddressRequests.addEventListener('click', function() {
              const count = App.addressRequests.length;
              
              if (confirm(`住所変更届 ${count}件 を削除しますか？`)) {
                App.addressRequests = [];
                App.save();
                alert(`${count}件の住所変更届を削除しました`);
                self.render('dataManagement');
              }
            });
          }
          
          // 選択した現場を削除
          const deleteSelectedSites = document.getElementById('deleteSelectedSites');
          if (deleteSelectedSites) {
            deleteSelectedSites.addEventListener('click', function() {
              const checkedBoxes = document.querySelectorAll('.site-checkbox:checked');
              if (checkedBoxes.length === 0) {
                alert('削除する現場を選択してください');
                return;
              }
              
              const siteIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-site-id'));
              const siteNames = siteIds.map(id => {
                const site = App.jobSites.find(s => s.id === id);
                return site ? site.name : '';
              }).filter(n => n);
              
              if (confirm(`以下の現場を削除しますか？\n\n${siteNames.join('\n')}\n\n関連する勤怠記録・収支データも削除されます。`)) {
                // 現場を削除
                App.jobSites = App.jobSites.filter(s => !siteIds.includes(s.id));
                
                // 関連する勤怠記録を削除
                siteNames.forEach(name => {
                  App.records = App.records.filter(r => r.jobSiteName !== name);
                });
                
                // 関連する収支データを削除
                siteIds.forEach(id => {
                  Object.keys(App.siteFinanceData).forEach(key => {
                    if (key.startsWith(id + '_')) {
                      delete App.siteFinanceData[key];
                    }
                  });
                });
                
                // 関連する日報データを削除
                siteNames.forEach(name => {
                  Object.keys(App.siteDailyReports).forEach(key => {
                    if (key.endsWith('_' + name)) {
                      delete App.siteDailyReports[key];
                    }
                  });
                });
                
                App.save();
                alert(`${siteNames.length}件の現場を削除しました`);
                self.render('dataManagement');
              }
            });
          }
          
          // 全データリセット
          const resetAllData = document.getElementById('resetAllData');
          if (resetAllData) {
            resetAllData.addEventListener('click', function() {
              if (confirm('⚠️ 警告 ⚠️\n\n本当にすべてのデータを削除しますか？\n\n・勤怠記録\n・現場データ\n・収支データ\n・修正依頼\n・住所変更届\n\nすべて初期状態に戻ります。\nこの操作は取り消せません。')) {
                if (confirm('最終確認：本当に削除してよろしいですか？')) {
                  localStorage.clear();
                  alert('全データを削除しました。\nページをリロードします。');
                  location.reload();
                }
              }
            });
          }
        }

        // CSVエクスポート
        if (view === 'csvExport') {
          const exportMonth = document.getElementById('exportMonth');
          const previewCount = document.getElementById('previewCount');
          const exportBtn = document.getElementById('exportCsvBtn');

          // プレビュー更新
          function updatePreview() {
            const month = exportMonth.value;
            const records = App.records.filter(r => r.workDate && r.workDate.startsWith(month));
            previewCount.textContent = records.length;
          }

          if (exportMonth) {
            exportMonth.addEventListener('change', updatePreview);
            updatePreview();
          }

          if (exportBtn) {
            exportBtn.addEventListener('click', function() {
              const month = exportMonth.value;
              const exportType = document.querySelector('input[name="exportType"]:checked').value;
              const records = App.records.filter(r => r.workDate && r.workDate.startsWith(month));

              if (records.length === 0) {
                alert('選択した月のデータがありません');
                return;
              }

              // 法定休憩時間を計算する関数
              function getBreakHours(workHours) {
                if (workHours <= 6) return 0;
                if (workHours <= 8) return 0.75; // 45分
                return 1; // 60分
              }

              let csv = '';
              const BOM = '\uFEFF';

              if (exportType === 'daily') {
                // 出勤一覧
                csv = '日付,従業員名,役割,現場名,始業時刻,終業時刻,勤務時間,休憩時間,実働時間,時給,日給,メモ\n';
                records.sort((a, b) => a.workDate.localeCompare(b.workDate)).forEach(r => {
                  const emp = App.employees.find(e => e.name === r.employeeName);
                  const role = emp ? (emp.role === 'parttime' ? 'アルバイト' : (emp.role === 'manager' ? '責任者' : '作業員')) : '作業員';
                  const isParttime = emp && emp.role === 'parttime';
                  const workHours = r.workHours || 0;
                  const breakHours = isParttime ? getBreakHours(workHours) : 0;
                  const actualHours = Math.max(0, workHours - breakHours);
                  // 記録に時給があればそれを使う
                  const recordRate = r.hourlyRate || (emp ? emp.hourlyRate : 0);
                  const dailyPay = isParttime ? Math.round(actualHours * recordRate) : (emp ? emp.dailyRate : 15000);
                  csv += `${r.workDate},${r.employeeName},${role},${r.jobSiteName},${App.formatTime(r.clockInTime)},${App.formatTime(r.clockOutTime)},${workHours.toFixed(1)},${breakHours.toFixed(2)},${actualHours.toFixed(1)},${isParttime ? recordRate : '-'},${dailyPay},"${r.memo || ''}"\n`;
                });
              } else if (exportType === 'summary') {
                // 月次集計
                csv = '従業員名,役割,始業日数,合計勤務時間,合計休憩時間,合計実働時間,給与概算\n';
                const summary = {};
                records.forEach(r => {
                  if (!summary[r.employeeName]) {
                    const emp = App.employees.find(e => e.name === r.employeeName);
                    summary[r.employeeName] = {
                      days: 0,
                      hours: 0,
                      breakHours: 0,
                      actualHours: 0,
                      totalPay: 0,
                      role: emp ? emp.role : 'worker',
                      dailyRate: emp ? emp.dailyRate : 15000,
                      hourlyRate: emp ? emp.hourlyRate : 0
                    };
                  }
                  if (r.status === 'completed') {
                    const workHours = r.workHours || 0;
                    const isParttime = summary[r.employeeName].role === 'parttime';
                    const breakHours = isParttime ? getBreakHours(workHours) : 0;
                    const actualHours = Math.max(0, workHours - breakHours);
                    summary[r.employeeName].days++;
                    summary[r.employeeName].hours += workHours;
                    summary[r.employeeName].breakHours += breakHours;
                    summary[r.employeeName].actualHours += actualHours;
                    // 記録の時給で計算（アルバイト）、または日当（正社員）
                    if (isParttime) {
                      const recordRate = r.hourlyRate || summary[r.employeeName].hourlyRate;
                      summary[r.employeeName].totalPay += Math.round(actualHours * recordRate);
                    } else {
                      summary[r.employeeName].totalPay += summary[r.employeeName].dailyRate;
                    }
                  }
                });
                Object.keys(summary).forEach(name => {
                  const s = summary[name];
                  const roleText = s.role === 'parttime' ? 'アルバイト' : (s.role === 'manager' ? '責任者' : '作業員');
                  csv += `${name},${roleText},${s.days},${s.hours.toFixed(1)},${s.breakHours.toFixed(1)},${s.actualHours.toFixed(1)},${s.totalPay}\n`;
                });
              } else if (exportType === 'site') {
                // 現場別集計
                csv = '現場名,始業人数,合計人日,従業員一覧\n';
                const siteSummary = {};
                records.forEach(r => {
                  if (!siteSummary[r.jobSiteName]) {
                    siteSummary[r.jobSiteName] = {
                      count: 0,
                      workers: []
                    };
                  }
                  if (r.status === 'completed') {
                    siteSummary[r.jobSiteName].count++;
                    if (!siteSummary[r.jobSiteName].workers.includes(r.employeeName)) {
                      siteSummary[r.jobSiteName].workers.push(r.employeeName);
                    }
                  }
                });
                Object.keys(siteSummary).forEach(site => {
                  const s = siteSummary[site];
                  csv += `${site},${s.workers.length},${s.count},"${s.workers.join('、')}"\n`;
                });
              }

              // ダウンロード
              const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `勤怠_${month}_${exportType}.csv`;
              link.click();
              URL.revokeObjectURL(url);
            });
          }
        }
      }
    };

    // アプリ起動
    Views.render('login');
  </script>
</body>
</html>
